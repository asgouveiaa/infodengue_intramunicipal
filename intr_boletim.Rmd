---
title: "jv_intramunicipal_ok"
author: "Ayrton e Thais"
date: "2025-09-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(error = TRUE)  # Show errors but continue knitting
```

```{r pacotes, include=FALSE}
# Configuração inicial
pacman::p_load(
  tidyverse,sf,magrittr,fuzzyjoin,
  lubridate,ggpubr,cowplot,gtable,
  nowcaster, AlertTools,epical,gt,
  assertthat, patchwork, kableExtra
)

source("./funcoes_submunicipal.R")

ano_atual <- year(Sys.Date())

```

```{r Carregando dados, message=FALSE, warning=FALSE, cache=FALSE, include=FALSE}

# DADOS REFERÊNCIA
jv_pop <- read_csv2(
  file = "./dados_ref/joinville_pop.csv") %>% 
  mutate(nome_bairr = normalizar_bairro(nome_bairr)
) %>% select(nome_bairr,id_bairro,pop)

jv_ref <- read_csv2(
  file = "./dados_ref/joinville_ref.csv",
  locale = locale(encoding = "Latin1")) %>% 
  mutate(nome_bairr = normalizar_bairro(nome_bairr)
)

jv_shp <- read_sf("./shapes/Joishapes/joiBairros/joiBairros.shp") %>% 
  mutate(nome_bairr = normalizar_bairro(nome_bairr))

jv_distritos_shp <- read_sf("./shapes/Joishapes/joiDistritos/joiDistr.shp") %>% 
  rename(distrito = Distrito)

jv_mun_shape <- geobr::read_municipality(code_muni = 4209102)

# Dados para níveis de alerta
load("./Rt/clijv.RData") #substituir pelo downscale 
load("./Rt/paramsjv.RData")

# Dados historico alerta

#### DADOS QUE VINICIUS MANDOU DE DENGUE VAO ATÈ SE34
# dados_api_dengue <- read.csv2("./data/historico_alerta_joinville.csv") %>% 
#   mutate(arbo = "dengue")

dados_api_dengue <- read.csv("./data/se36/hist_dengue_completo.csv") %>% 
  mutate(arbo = "dengue") %>% select(-c(notif_accum_year))


dados_api_chikon <- read.csv("./data/se36/historico_chik.csv") %>% 
  mutate(arbo = "chikon") %>% select(-c(municipio_nome,municipio_geocodigo))

dados_api <- rbind(dados_api_dengue,
                   dados_api_chikon)



# Dados notificação 
df_mun <- read.csv("./data/se36/notif_completo.csv")  %>% 
  mutate(sem_not = paste0(ano_notif,sprintf("%02d",se_notif)),
         arbo = case_when(
           cid10_codigo == "A90" ~ "dengue",
           cid10_codigo == "A92.0" ~ "chikon",
           cid10_codigo == "A928" ~ "zika")
         ) %>% 
  arrange(sem_not)

# Semanas alvo
weeks_2_plot <- tail(
  sort(unique(factor(df_mun$sem_not))), 3
)

##### MEM JOINVILLE
limiar_preseason <- 7.12
limiar_epidemico <- 72.46
limiar_posseason <- 9.38

##### DADOS DISTRITOS TEMP DOWNSCALING (NOVO)
distrito_downsc <- read.csv("./data/se36/dist_temp_min_ate36.csv") %>% 
  mutate(receptivo = ifelse(mean_pred > 18,1,0))

```

```{r processar_dados, include=FALSE, cache=FALSE}
##### PROCESSAR DADOS PRINCIPAIS
df_mun %<>% 
  #filter(NU_ANO %in% c(ano_atual-1, ano_atual)) %>%
   mutate(dt_digita = as.Date(dt_digita, format = "%Y-%m-%d"),
     dt_sin_pri = as.Date(dt_sin_pri, format = "%Y-%m-%d"),
     dt_notific = as.Date(dt_notific, format = "%Y-%m-%d"))


#### NORMALIZAR NOMES DE BAIRROS E FAZER MATCHING
df_mun_filtrado <- df_mun %>% 
  mutate(nm_bairro_norm = normalizar_bairro(nm_bairro)) %>%
  filter(!is.na(nm_bairro_norm))

df_mun_ok <- stringdist_inner_join(
  df_mun_filtrado,
  tibble(nm_bairro_ref = jv_ref$nome_bairr),
  by = c("nm_bairro_norm" = "nm_bairro_ref"),
  method = "lv",
  max_dist = 2
)

##### CLASSIFICAR BAIRROS EM DISTRITOS
res_distritos <- classificar_bairros_distrito(
    sp_distritos = jv_distritos_shp,
    sp_bairros = jv_shp) %>% 
  mutate(nome_bairr = normalizar_bairro(nome_bairr)) 


##### SUMARIZAR POR BAIRRO E SE
df_bairros <- df_mun_ok %>% 
  count(arbo, nm_bairro_ref,
        sem_not, name = "notificações") %>%
  mutate(sem_not = as.numeric(sem_not)) %>% 
  completar_dados_bairros(
    bairros_unicos = unique(df_mun_ok$nm_bairro_ref),
    se_var = "sem_not",
    nm_bairr_var = "nm_bairro_ref", group_var = "arbo",
    max_semana_epidemiologica = weeks_2_plot[3]
  ) %>%
  left_join(jv_pop,
            by = c("nm_bairro_ref" = "nome_bairr")) %>%
  left_join(jv_shp,
            by = c("nm_bairro_ref"= "nome_bairr")) %>% 
  left_join(res_distritos,
            by = c("nm_bairro_ref"= "nome_bairr")) %>% 
  select(nm_bairro_ref, sem_not, arbo, distrito, 
         notificações,pop,geometry,geometry_distritos)

df_distritos <- df_bairros %>%
  group_by(distrito,sem_not, arbo) %>%
  summarise(
    pop = sum(pop, na.rm = TRUE),
    notificações = sum(notificações, na.rm = TRUE),
    geometry = st_union(geometry_distritos),
    .groups = "drop"
  ) %>%
  mutate(
    inc = notificações/pop*1e5,
    ano = substr(sem_not, 1, 4)
  ) %>%
  filter(ano %in% c(ano_atual-1, ano_atual))
  
##### DADOS NOWCASTING MUNICÍPIO
nowcastdg_mun <- df_mun  %>% 
  filter(year(dt_sin_pri) %in% c(ano_atual-2, ano_atual-1, ano_atual) & arbo == "dengue") %>%
  drop_na(dt_sin_pri, dt_digita) %>%
  select(arbo,dt_digita, dt_sin_pri,dt_notific)

##### DADOS NOWCASTING DISTRITO
nowcastdg_dis <- df_mun_ok %>% 
  filter(arbo == "dengue") %>% 
  left_join(res_distritos %>% 
              select(nome_bairr,distrito),
            by = c("nm_bairro_ref"="nome_bairr")) %>% 
  select(dt_digita, dt_sin_pri,dt_notific,distrito) #%>% 
  #na.omit()


##### ADICIONAR SHAPE MUNICIPIO NOS DADOS API (acho que não está sendo utilizado)
# dados_api_dengon$geometry_mun <- sf::st_union(jvmun_shape$geom) 
# dados_api_chikon$geometry_mun <- sf::st_union(jvmun_shape$geom) 
```

```{r perca_de_info, include=FALSE, cache=FALSE}

df_mun_id_bairro_miss <- df_mun %>% 
  group_by(sem_not,arbo) %>% 
  summarise(
    total_id = n(),
    n_missing = sum(id_bairro == 0 | is.na(id_bairro), na.rm = TRUE),
    perc_na_id = 100*(n_missing/total_id)
  ) 

df_mun_nm_bairro_miss <- df_mun %>% 
  group_by(sem_not,arbo) %>% 
  summarise(
    total_nm = n(),
    n_na_nm = sum(is.na(nm_bairro)),  
    perc_na_nome = 100*(n_na_nm/total_nm)
  ) 

df_mun_miss <- left_join(df_mun_id_bairro_miss,
      df_mun_nm_bairro_miss) %>% as.data.frame() 
```

```{r calculando_alerts, include=FALSE,cache=FALSE}
ultimas_semanas <- tail(sort(unique(df_mun$sem_not)), 5)

#### DISTRITOS
df_distritos %<>% 
  rename(casos = notificações) %>% 
  left_join(dados_api %>% 
              ungroup() %>% 
              select(SE, tempmin,arbo) %>% 
              rename(temp_min = tempmin),
            by = c("sem_not" = "SE","arbo")) %>% 
  mutate(id_distrito = case_when(
      distrito == "Distrito Norte" ~ 1,
      distrito == "Distrito Sul" ~ 2,
      distrito == "Distrito Centro" ~ 3),
    ano = as.numeric(substr(sem_not, 1, 4)),
    inc = casos/pop*1e5) %>%
  as.data.frame()

# Calcular alertas para todos os distritos
ids_distrito <- unique(df_distritos$id_distrito)
nomes_distrito <- unique(df_distritos$distrito)

df_distritos_dengon <- map2_dfr(
  ids_distrito, nomes_distrito, calcular_alerta,
  data = df_distritos %>% filter(arbo == "dengue") %>% distinct(),
  coluna_id = "id_distrito",
  gtdist = "normal",
  meangt = 3,
  sdgt = 1
  )

if (any(df_distritos$arbo == "chikon", na.rm = TRUE)) {
  df_distritos_chikon <- map2_dfr(
    ids_distrito, nomes_distrito, calcular_alerta,
    data = df_distritos %>% filter(arbo == "chikon") %>% distinct(),
    coluna_id = "id_distrito",
    gtdist = "normal",
    meangt = 2,
    sdgt = 2
  )
  
  df_distritos <- rbind(df_distritos_dengon, df_distritos_chikon)
} else {

  df_distritos <- df_distritos_dengon
}

#### BAIRROS
df_bairros %<>% 
  rename(casos = notificações) %>% 
  left_join(dados_api %>% 
              ungroup() %>% 
              select(SE, tempmin,arbo) %>% 
              rename(temp_min = tempmin),
            by = c("sem_not" = "SE","arbo")) %>% 
  mutate(id_bairro = as.numeric(factor(nm_bairro_ref)),
    ano = as.numeric(substr(sem_not, 1, 4)),
    inc = casos/pop*1e5) %>%
  as.data.frame()

# Calcular alertas para todos os distritos
ids_bairro <- unique(df_bairros$id_bairro)
nomes_bairro <- unique(df_bairros$nm_bairro_ref)


df_bairros_dengon <- map2_dfr(
  ids_bairro, nomes_bairro, calcular_alerta,
  data = df_bairros %>% filter(arbo == "dengue") %>% distinct(),
  coluna_id = "id_bairro",
  gtdist = "normal",
  meangt = 3,
  sdgt = 1
  )

if (any(df_bairros$arbo == "chikon", na.rm = TRUE)) {
  df_bairros_chikon <- map2_dfr(
    ids_bairro, nomes_bairro, calcular_alerta,
    data = df_bairros %>% filter(arbo == "chikon") %>% distinct(),
    coluna_id = "id_bairro",
    gtdist = "normal",
    meangt = 3,
    sdgt = 1)
  
  df_bairros <- rbind(df_bairros_dengon,df_bairros_chikon)
} else {

  df_bairros <- df_bairros_dengon
}
```

```{r nowscating, include=FALSE, cache=FALSE}
#### MUNICIPIO
mun_nowscasting <-  nowcasting_inla(
  dataset = nowcastdg_mun,
  data.by.week = TRUE,
  date_onset = dt_sin_pri,
  date_report = dt_digita,
  K = 1, Dmax = 5
)

# Preparar dados observados (incluir arbo para selecionar apenas degon aqui)
mun_observados <- nowcastdg_mun %>%
  filter(arbo == "dengue") %>% 
  mutate(
    dt_event = dt_sin_pri,
    epiweek = epical::epi_week(dt_event)[[1]],
    ano = year(dt_event),
    ano_epi = paste0(ano, str_pad(epiweek, width = 2, pad = "0")) 
  ) %>% 
  count(ano_epi, dt_event, name = "total_Y") %>%
  filter(total_Y != 0 & ano_epi >= paste0(ano_atual - 1, "01")) %>%
  group_by(ano_epi) %>%
  summarise(total_Y = sum(total_Y)) %>%
  left_join(
    dados_api %>% filter(arbo == "dengue") %>% 
      mutate(SE = as.character(SE)) %>% select(SE, nivel),
    by = c("ano_epi" = "SE")
  )

mun_nowcast <- mun_nowscasting$total %>%
  mutate(
    ano = year(dt_event),
    epiweek = epical::epi_week(dt_event)[[1]],
    ano_epi = case_when(
      epiweek == 1 & lag(epiweek, default = 52) == 52 ~ 
        paste0(year(dt_event) + 1, str_pad(epiweek, width = 2, pad = "0")),
      TRUE ~ paste0(year(dt_event), str_pad(epiweek, width = 2, pad = "0"))
    ),
    type = case_when(
      ano_epi > as.numeric(as.character(weeks_2_plot[3])) ~ 'Forecasting',
      TRUE ~ "Nowcasting"
    )
  )

jv_mun_nowscat <- list(mun_observados = mun_observados,
                       mun_nowcast = mun_nowcast)
#### DISTRITOS
# Processar dados de nowcast para todos os distritos
jv_distritos_nowcast <- map(
  nomes_distrito,
  processar_nowcast_distrito,
  dados_distrito = nowcastdg_dis,
  K = 2,
  Dmax = 7)

names(jv_distritos_nowcast) <- nomes_distrito

###### incluir no código e já calcular a incidência
populacoes_distritos <- c(
  "Distrito Centro" = 174752,
  "Distrito Norte" = 147823,
  "Distrito Sul" = 174616
)
```

```{r definindo_bairros_plotar, include=FALSE,cache=FALSE}

bairros_ultima_semana_dengue <- df_bairros %>%
  filter(arbo == "dengue") %>% 
  filter(sem_not == weeks_2_plot[3]) %>% 
  slice_head(n = 10) %>% 
  select(nm_bairro_ref,distrito,casos,inc,Rt,nivel) %>% 
  mutate(Rt = ifelse(is.na(Rt),0,Rt))

bairros_ultima_semana_dengue$semanas_com_nivel3_4 <- sapply(
  bairros_ultima_semana_dengue$nm_bairro_ref, 
  function(bairro) calcular_semanas_alerta_alto(df_bairros %>%
  filter(arbo == "dengue"),
  weeks_2_plot[3], bairro, janela = 5)
) 

bairros_ultima_semana_dengue %<>%
  arrange(desc(inc))

bairros_ultima_semana_chikon <- df_bairros %>%
  filter(arbo == "chikon") %>% 
  filter(sem_not == weeks_2_plot[3]) %>% 
  slice_head(n = 10) %>% 
  select(nm_bairro_ref,distrito,casos,inc,Rt,nivel) %>% 
  mutate(Rt = ifelse(is.na(Rt),0,Rt))

bairros_ultima_semana_chikon$semanas_com_nivel3_4 <- sapply(
  bairros_ultima_semana_chikon$nm_bairro_ref, 
  function(bairro) calcular_semanas_alerta_alto(df_bairros %>%
  filter(arbo == "chikon"),
  weeks_2_plot[3], bairro, janela = 10)
)

bairros_ultima_semana_chikon %<>%
  arrange(desc(inc))
```

```{r include=FALSE}

##### NOVAS ANÁLISES (ÍNDICE P E NOWCAST COM DEPENDÊNCIA ESPACIAL)

```


```{r, include= FALSE, cache=FALSE}
### CURVA DE INCIDÊNCIA E NIVEIS DE ALERTA 

## MUNICÍPIO
# DENGON
{
jv_inc_mun_dengon <- create_incidence_plot( 
  nowcast_data = jv_mun_nowscat$mun_nowcast, 
  observed_data = jv_mun_nowscat$mun_observados, 
  title_suffix = paste0("Curva de incidência de dengue - Joinville até SE", weeks_2_plot[3]),
  include_zoom = F, convert_to_incidence = T, pop = 616317
)
}


if (any(dados_api$arbo == "chikon", na.rm = TRUE)){

min_val <- min(dados_api %>% 
                 filter(arbo == "chikon") %>% 
                 pull(p_inc100k))
  
max_val <- max(dados_api %>% 
                 filter(arbo == "chikon") %>% 
                 pull(p_inc100k))

 p_chik_main <- ggplot(dados_api %>%
                         filter(arbo == "chikon" & SE >= paste0(ano_atual-1,substr(weeks_2_plot[3],5,6)))) +
  geom_segment(
    aes(x = factor(SE), xend = factor(SE), 
        y = 0, yend = p_inc100k, color = factor(nivel)),
    linewidth = 0.7
  ) +
  geom_line(
    aes(x = factor(SE), y = p_inc100k, group = 1),
    color = "steelblue", linewidth = 1
  ) +
  geom_hline(yintercept = 72, col = "red", show.legend = F) +
  scale_color_manual(
    name = NULL,
    values = c("1" = "green", "2" = "yellow", 
               "3" = "orange", "4" = "red"),
    labels = c("1" = "Baixo Risco", 
               "2" = "Receptivo",
               "3" = "Transmissão",
               "4" = "Alta atividade"),
    breaks = c("1", "2", "3", "4")
  ) +
  scale_y_continuous(
    limits= c(min_val,max_val+2)
  ) +
  scale_x_discrete(
        breaks = levels(factor(dados_api$SE))[
          seq(1, nlevels(factor(dados_api$SE)), by = 8)]
  ) +
  theme_minimal() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1)
      )  +
      labs(
        x = "Semanas Epidemiológicas",
        y = "Incidência (casos por 100.000 hab.)",
        title = paste0("Curva de incidência de chikungunya - Joinville Até SE","", weeks_2_plot[3]) 
      )
  
 p_chik_zoom <- dados_api %>% 
   filter(arbo == "chikon" & SE %in% ultimas_semanas) %>%
   ggplot() +
   geom_segment(
     aes(x = factor(SE), xend = factor(SE),
         y = 0, yend = p_inc100k, color = factor(nivel)),
     linewidth = 0.8
   ) +
   geom_line(
     aes(x = factor(SE), y = p_inc100k, group = 1),
     color = "steelblue", linewidth = 1.2
   ) +
   scale_color_manual(
     values = c("Nowcasting" = "blue", "1" = "green", "2" = "yellow",
                "3" = "orange", "4" = "red")
   ) +
   scale_fill_manual(values = c("Nowcasting" = "blue"), guide = "none") +
   theme_minimal() +
   theme(
     legend.position = "none",
     axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
     title = element_text(size = 6),
     plot.background = element_rect(fill = "white", color = "gray"),
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank()
   ) +
   labs(x = NULL, y = NULL, title = "Últimas 5 semanas") +
   scale_x_discrete(
     breaks = levels(factor(dados_api$SE))[
       seq(1, nlevels(factor(dados_api$SE)), by = 1)]
   ) 
 
jv_inc_mun_chikon <-  p_chik_main #+
  # inset_element(
  #   p_chik_zoom,
  #   left = 0.6,
  #   bottom = 0.4,
  #   right = 1,
  #   top = 1)

} else {
  jv_inc_mun_chikon <- NULL
}


## DISTRITO
# DENGON
jv_inc_distritos_dengon <- map(names(jv_distritos_nowcast), ~ {
  distrito_nome <- .x
  create_incidence_plot(
    nowcast_data = jv_distritos_nowcast[[distrito_nome]]$nowcast$total,
    observed_data = jv_distritos_nowcast[[distrito_nome]]$observado,
    distrito_nome = distritos_nomes, 
    convert_to_incidence = T,
    pop = populacoes_distritos[distrito_nome],
    include_zoom = F, 
    title_suffix = distrito_nome)
})

# CHIKON

if (any(df_distritos$arbo == "chikon", na.rm = TRUE)){
min_val <- min(df_distritos %>% filter(arbo == "chikon") %>% 
                 pull(inc), na.rm = T)

max_val <- max(df_distritos %>% filter(arbo == "chikon") %>% 
                 pull(inc), na.rm = T)

min_val_zoom <- min(df_distritos  %>%  filter(arbo == "chikon" & sem_not %in% tail(sort(unique(df_distritos$sem_not)), 5)) %>%  
                      pull(inc))

max_val_zoom <- max(df_distritos  %>%  filter(arbo == "chikon" & sem_not %in% tail(sort(unique(df_distritos$sem_not)), 5)) %>%  
                      pull(inc))

jv_inc_distritos_chikon <- 
  df_distritos %>% filter(arbo == "chikon" & 
                          sem_not >= paste0(ano_atual-1,substr(weeks_2_plot[3],5,6))) %>% 
  group_split(distrito) %>%
  map(~{
    df_plot <- .x
    ultimas_semanas <- tail(sort(unique(df_distritos$sem_not)), 5)
    
 p_main <-  ggplot(df_plot %>% 
                     filter(sem_not >= paste0(sem_not-1,substr(weeks_2_plot[3],5,6)))) +
  geom_segment(
    aes(x = factor(sem_not), xend = factor(sem_not), 
        y = 0, yend = inc, color = factor(nivel)),
    linewidth = 0.7
  ) +
  geom_line(
    aes(x = factor(sem_not), y = inc, group = 1),
    color = "steelblue", linewidth = 1
  ) +
  geom_hline(yintercept = 72, col = "red", show.legend = F) +
  scale_color_manual(
    name = NULL,
    values = c("1" = "green", "2" = "yellow", 
               "3" = "orange", "4" = "red"),
    labels = c("1" = "Baixo Risco", 
               "2" = "Receptivo",
               "3" = "Transmissão",
               "4" = "Alta atividade"),
    breaks = c("1", "2", "3", "4")
  ) +
  scale_y_continuous(
    limits= c(min_val,max_val+5)
  ) +
  scale_x_discrete(
        breaks = levels(factor(df_plot$sem_not))[
          seq(1, nlevels(factor(df_plot$sem_not)), by = 8)]
  ) +
  theme_minimal() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1)
      )  +
      labs(
        x = "Semanas Epidemiológicas",
        y = "Incidência (casos por 100.000 hab.)",
        title = paste0(unique(df_plot$distrito))
      )
  
 p_zoom <- df_plot %>% 
   filter(sem_not %in% ultimas_semanas) %>%
   ggplot() +
   geom_segment(
     aes(x = factor(sem_not), xend = factor(sem_not),
         y = 0, yend = inc, color = factor(nivel)),
     linewidth = 0.8
   ) +
   geom_line(
     aes(x = factor(sem_not), y = inc, group = 1),
     color = "steelblue", linewidth = 1.2
   ) +
   scale_color_manual(
     values = c("Nowcasting" = "blue", "1" = "green", "2" = "yellow",
                "3" = "orange", "4" = "red")
   ) +
   scale_fill_manual(values = c("Nowcasting" = "blue"), guide = "none") +
   theme_minimal() +
   theme(
     legend.position = "none",
     axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
     axis.text.y = element_text(size = 7),
     title = element_text(size = 6),
     plot.background = element_rect(fill = "white", color = "gray"),
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank()
   ) +
    scale_y_continuous(
    limits= c(min_val_zoom,max_val_zoom)
  ) +
   labs(x = NULL, y = NULL, title = "Últimas 5 semanas") +
   scale_x_discrete(
     breaks = levels(factor(df_plot$sem_not))[
       seq(1, nlevels(factor(df_plot$sem_not)), by = 1) ]
   ) 
 
 # Combinar os gráficos
 p_main #+ inset_element(p_zoom, left = 0.6, bottom = 0.3, right = 1, top = 1)

  })
} else {
  jv_inc_distritos_chikon <- NULL
}


## BAIRROS
# DENGON
top_3_bairros_dengon <- df_bairros %>% 
  filter(sem_not == weeks_2_plot[3] & arbo == "dengue") %>% 
  arrange(desc(inc)) %>%
  slice_head(n = 3) %>%
  select(nm_bairro_ref) %>%
  pull()

top_3_bairros_chikon <- df_bairros %>% 
  filter(sem_not == weeks_2_plot[3] & arbo == "chikon") %>% 
  arrange(desc(inc)) %>%
  slice_head(n = 3) %>%
  select(nm_bairro_ref) %>%
  pull()


# DENGON
{
min_val <- min(df_bairros %>%
                 filter(arbo == "dengue" & 
                        sem_not >= paste0(ano_atual-1,substr(weeks_2_plot[3],5,6))) %>% pull(inc), na.rm = T)
  

max_val <- max(df_bairros %>%
                 filter(arbo == "dengue" & 
                        sem_not >= paste0(ano_atual-1,substr(weeks_2_plot[3],5,6))) %>% pull(inc), na.rm = T)


min_val_zoom <- min(df_bairros %>%  filter(arbo == "dengue" & sem_not %in% tail(sort(unique(df_bairros$sem_not)), 5)) %>% pull(inc))

max_val_zoom <- max(df_bairros |> filter(arbo == "dengue" & sem_not %in% tail(sort(unique(df_bairros$sem_not)), 5)) %>% pull(inc))

jv_inc_bairros_dengon <- df_bairros %>% 
  filter(nm_bairro_ref %in% top_3_bairros_dengon & arbo == "dengue" & 
        sem_not >= paste0(ano_atual-1,substr(weeks_2_plot[3],5,6))) %>%
  group_split(nm_bairro_ref) %>%
  map(~{
    dados_bairro <- .x
    ultimas_semanas <- tail(sort(unique(dados_bairro$sem_not)), 5)
    
    # Gráfico principal
    p_main <- ggplot(dados_bairro %>% distinct) +
      geom_segment(
        aes(x = factor(sem_not), xend = factor(sem_not), 
            y = 0, yend = inc, color = factor(nivel)),
        linewidth = 0.7
      ) +
      geom_line(
        aes(x = factor(sem_not), y = inc, group = 1),
        color = "steelblue", linewidth = 1
      ) +
      #geom_hline(yintercept = 72, col = "red", show.legend = F) +
      scale_color_manual(
        name = NULL,
        values = c("1" = "green", "2" = "yellow", 
                   "3" = "orange", "4" = "red"),
        labels = c("1" = "Baixo Risco", 
                   "2" = "Receptivo",
                   "3" = "Transmissão",
                   "4" = "Alta atividade"),
        breaks = c("1", "2", "3", "4")
      ) +
      theme_minimal() +
      theme(
        legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1)
      ) +
      scale_x_discrete(
        breaks = levels(factor(dados_bairro$sem_not))[
          seq(1, nlevels(factor(dados_bairro$sem_not)), by = 8)]
      ) +
      scale_y_continuous(limits = c(min_val,max_val+1)) +
      labs(
        x = "Semanas Epidemiológicas",
        y = "Incidência (casos por 100.000 hab.)",
        title = unique(dados_bairro$nm_bairro_ref)
      )
    
    # Gráfico de zoom (últimas 10 semanas)
    p_zoom <- dados_bairro %>% 
      filter(sem_not %in% ultimas_semanas) %>%
      ggplot() +
      geom_segment(
        aes(x = factor(sem_not), xend = factor(sem_not),
            y = 0, yend = inc, color = factor(nivel)),
        linewidth = 0.8
      ) +
      geom_line(
        aes(x = factor(sem_not), y = inc, group = 1),
        color = "steelblue", linewidth = 1.2
      ) +
      scale_color_manual(
        values = c("Nowcasting" = "blue", "1" = "green", "2" = "yellow",
                   "3" = "orange", "4" = "red")
      ) +
      scale_fill_manual(values = c("Nowcasting" = "blue"), guide = "none") +
      theme_minimal() +
      theme(
        legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        axis.text.y = element_text(size = 7.5),
        title = element_text(size = 6),
        plot.background = element_rect(fill = "white", color = "gray"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      ) +
      labs(x = NULL, y = NULL, title = "Últimas 5 semanas") +
      scale_y_continuous(limits = c(min_val_zoom,max_val_zoom+1)) +
      scale_x_discrete(
        breaks = levels(factor(dados_bairro$sem_not))[
          seq(1, nlevels(factor(dados_bairro$sem_not)), by = 1)]
      ) 
    
    # Combinar os gráficos
    p_main #+ inset_element(p_zoom, left = 0.6, bottom = 0.3, right = 1, top = 1)
  })

# Nomear os elementos da lista com os nomes dos bairros
names(jv_inc_bairros_dengon) <- df_bairros %>% 
  filter(nm_bairro_ref %in% top_3_bairros_dengon) %>% 
  pull(nm_bairro_ref) %>% 
  unique()
}

# CHIKON
if(length(top_3_bairros_chikon) > 0 && !identical(top_3_bairros_chikon, character(0))) {

min_val <- min(df_bairros %>%
                 filter(arbo == "chikon" & 
                        sem_not >= paste0(ano_atual-1,substr(weeks_2_plot[3],5,6))) %>% pull(inc), na.rm = T)

max_val <- max(df_bairros %>%
                 filter(arbo == "chikon" & 
                        sem_not >= paste0(ano_atual-1,substr(weeks_2_plot[3],5,6))) %>% pull(inc), na.rm = T)


  
min_val_zoom <- min(df_bairros |>
                      filter(sem_not %in% tail(sort(unique(df_bairros$sem_not)), 5) & arbo == "chikon") %>%
                      pull(inc))

max_val_zoom <- max(df_bairros |>
                      filter(sem_not %in% tail(sort(unique(df_bairros$sem_not)), 5) & arbo == "chikon") %>%
                      pull(inc))

jv_inc_bairros_chikon <- df_bairros %>% 
  filter(nm_bairro_ref %in% top_3_bairros_dengon & arbo == "chikon" & 
         sem_not >= paste0(ano_atual-1,substr(weeks_2_plot[3],5,6))) %>%
  group_split(nm_bairro_ref) %>%
  map(~{
    dados_bairro <- .x
    ultimas_semanas <- tail(sort(unique(dados_bairro$sem_not)), 5)
    
    # Gráfico principal
    p_main <- ggplot(dados_bairro %>% distinct)  +
      geom_segment(
        aes(x = factor(sem_not), xend = factor(sem_not), 
            y = 0, yend = inc, color = factor(nivel)),
        linewidth = 0.7
      ) +
      geom_line(
        aes(x = factor(sem_not), y = inc, group = 1),
        color = "steelblue", linewidth = 1
      ) +
      #geom_hline(yintercept = 72, col = "red", show.legend = F) +
      scale_color_manual(
        name = NULL,
        values = c("1" = "green", "2" = "yellow", 
                   "3" = "orange", "4" = "red"),
        labels = c("1" = "Baixo Risco", 
                   "2" = "Receptivo",
                   "3" = "Transmissão",
                   "4" = "Alta atividade"),
        breaks = c("1", "2", "3", "4")
      ) +
      theme_minimal() +
      theme(
        legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1)
      ) +
      scale_x_discrete(
        breaks = levels(factor(dados_bairro$sem_not))[
          seq(1, nlevels(factor(dados_bairro$sem_not)), by = 8)]
      ) +
      scale_y_continuous(limits = c(min_val,max_val+1)) +
      labs(
        x = "Semanas Epidemiológicas",
        y = "Incidência (casos por 100.000 hab.)",
        title = unique(dados_bairro$nm_bairro_ref)
      )
    
    # Gráfico de zoom (últimas 10 semanas)
    p_zoom <- dados_bairro %>% 
      filter(sem_not %in% ultimas_semanas) %>%
      ggplot() +
      geom_segment(
        aes(x = factor(sem_not), xend = factor(sem_not),
            y = 0, yend = inc, color = factor(nivel)),
        linewidth = 0.8
      ) +
      geom_line(
        aes(x = factor(sem_not), y = inc, group = 1),
        color = "steelblue", linewidth = 1.2
      ) +
      scale_color_manual(
        values = c("Nowcasting" = "blue", "1" = "green", "2" = "yellow",
                   "3" = "orange", "4" = "red")
      ) +
      scale_fill_manual(values = c("Nowcasting" = "blue"), guide = "none") +
      theme_minimal() +
      theme(
        legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        axis.text.y = element_text(size = 7.5),
        title = element_text(size = 6),
        plot.background = element_rect(fill = "white", color = "gray"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      ) +
      labs(x = NULL, y = NULL, title = "Últimas 5 semanas") +
      scale_y_continuous(limits = c(min_val_zoom,max_val_zoom+1)) +
      scale_x_discrete(
        breaks = levels(factor(dados_bairro$sem_not))[
          seq(1, nlevels(factor(dados_bairro$sem_not)), by = 1)
        ]
      ) 
    
    # Combinar os gráficos
    p_main #+ inset_element(p_zoom, left = 0.6, bottom = 0.3, right = 1, top = 1)
  })
} else {
  jv_inc_bairros_chikon <- NULL
}

# Nomear os elementos da lista com os nomes dos bairros
if(length(top_3_bairros_chikon) > 0 && !identical(top_3_bairros_chikon, character(0))) {
  
names(jv_inc_bairros_chikon) <- df_bairros %>% 
  filter(nm_bairro_ref %in% top_3_bairros_chikon) %>% 
  pull(nm_bairro_ref) %>% 
  unique()
}

### FAIXAS DE ATIVIDADE

## MUNICIPIO

# DENGON
{
faixa_atividade_mun_dengon <- ggplot(
  dados_api %>%
    filter(arbo == "dengue" & SE >= 202401) ) +
  # Background rectangles using factor levels
  geom_rect(
    xmin = 0.5,
    xmax = length(unique(dados_api$SE)) + 0.5,
    ymin = 0,
    ymax = limiar_preseason,
    fill = "green", alpha = 0.3
  ) +
  geom_rect(
    xmin = 0.5,
    xmax = length(unique(dados_api$SE)) + 0.5,
    ymin = limiar_posseason,
    ymax = max(dados_api$p_inc100k + 150),
    fill = "red", alpha = 0.3
  ) +
  geom_rect(
    xmin = 0.5,
    xmax = length(unique(dados_api$SE)) + 0.5,
    ymin = limiar_preseason,
    ymax = limiar_epidemico,
    fill = "yellow", alpha = 0.3
  ) +
  # Data layers - SE as factor
  geom_segment(aes(x = as.factor(SE), y = p_inc100k, xend = as.factor(SE), yend = 0), col = "salmon") +
  geom_point(aes(x = as.factor(SE), y = p_inc100k)) +
  # Scales and theme
  scale_x_discrete(breaks = function(x) x[seq(1, length(x), by = max(1, length(x) %/% 5))]) +
  coord_cartesian(ylim = c(0, max(dados_api$p_inc100k))) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45)
  ) +
  labs(
        x = "Semanas Epidemiológicas",
        y = "Incidência (casos por 100.000 hab)",
        title = "Faixas de atividade baixa, média e alta - dengue"
)
}

# CHIKON

if (any(dados_api$arbo == "chikon", na.rm = TRUE)){
faixa_atividade_mun_chikon <- ggplot(
  dados_api %>%
    filter(arbo == "chikon" & SE >= 202401) ) +
  # Background rectangles using factor levels
  geom_rect(
    xmin = 0.5,
    xmax = length(unique(dados_api$SE)) + 0.5,
    ymin = 0,
    ymax = limiar_preseason,
    fill = "green", alpha = 0.3
  ) +
  geom_rect(
    xmin = 0.5,
    xmax = length(unique(dados_api$SE)) + 0.5,
    ymin = limiar_posseason,
    ymax = max(dados_api$p_inc100k + 150),
    fill = "red", alpha = 0.3
  ) +
  geom_rect(
    xmin = 0.5,
    xmax = length(unique(dados_api$SE)) + 0.5,
    ymin = limiar_preseason,
    ymax = limiar_epidemico,
    fill = "yellow", alpha = 0.3
  ) +
  # Data layers - SE as factor
  geom_segment(aes(x = as.factor(SE), y = p_inc100k, xend = as.factor(SE), yend = 0), col = "salmon") +
  geom_point(aes(x = as.factor(SE), y = p_inc100k)) +
  # Scales and theme
  scale_x_discrete(breaks = function(x) x[seq(1, length(x), by = max(1, length(x) %/% 5))]) +
  coord_cartesian(ylim = c(0, max(dados_api %>% 
                                    filter(arbo=="chikon") %>% pull(p_inc100k)))) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45)
  ) +
  labs(
        x = "Semanas Epidemiológicas",
        y = "Incidência (casos por 100.000 hab)",
        title = "Faixas de atividade baixa, média e alta - chikungunya"
)
} else {
  faixa_atividade_mun_chikon <- NULL
}

## DISTRITO
# Criar lista para armazenar os gráficos
faixa_atividade_distritos <- list()

# Obter combinações únicas de distrito e arbo
combinacoes <- df_distritos %>%
  distinct(distrito, arbo)

# Loop através de cada combinação distrito-arbo
for(i in 1:nrow(combinacoes)) {
  distrito_atual <- combinacoes$distrito[i]
  arbo_atual <- combinacoes$arbo[i]
  
  # Filtrar dados para o distrito e arbo atual
  dados_filtrados <- df_distritos %>%
    filter(distrito == distrito_atual, arbo == arbo_atual)
  
  # Definir título baseado na arbovirose
  titulo_arbo <- case_when(
    arbo_atual == "dengon" ~ "dengue",
    arbo_atual == "chikon" ~ "chikungunya",
    arbo_atual == "zikan" ~ "Zika",
    TRUE ~ "Arbovirose"
  )
  
  # Criar gráfico
  grafico <- ggplot(dados_filtrados) +
    # Background rectangles usando os limiares
    geom_rect(
      xmin = 0,
      xmax = length(unique(dados_filtrados$sem_not)) + 0.5,
      ymin = 0,
      ymax = limiar_preseason,
      fill = "green", alpha = 0.3
    ) +
    geom_rect(
      xmin = 0.5,
      xmax = length(unique(dados_filtrados$sem_not)) + 0.5,
      ymin = limiar_posseason,
      ymax = max(dados_filtrados$inc + 150, na.rm = TRUE),
      fill = "red", alpha = 0.3
    ) +
    geom_rect(
      xmin = 0.5,
      xmax = length(unique(dados_filtrados$sem_not)) + 0.5,
      ymin = limiar_preseason,
      ymax = limiar_epidemico,
      fill = "yellow", alpha = 0.3
    ) +
    # Data layers - SE as factor
    geom_segment(
      aes(x = as.factor(sem_not), y = inc, 
          xend = as.factor(sem_not), yend = 0), 
      col = "salmon"
    ) +
    geom_point(
      aes(x = as.factor(sem_not), y = inc)
    ) +
    # Scales and theme
    scale_x_discrete(
      breaks = function(x) x[seq(1, length(x), by = max(1, length(x) %/% 5))]
    ) +
    coord_cartesian(
      ylim = c(0, max(dados_filtrados$inc, na.rm = TRUE))
    ) +
    theme_minimal(base_size = 14) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1)
    ) +
    labs(
      x = "Semanas Epidemiológicas",
      y = "Incidência (casos por 100.000 hab.)",#,
      #title = paste("Faixas de atividade -", titulo_arbo),
      subtitle = paste(distrito_atual)
    )
  
  # Armazenar gráfico na lista
  nome_grafico <- paste(distrito_atual, arbo_atual, sep = "_")
  faixa_atividade_distritos[[nome_grafico]] <- grafico
}

### COMPARACAO HISTORICA

## MUNICIPIO

# DENGON
{
comp_mun_anos_dengon <- dados_api %>% filter(arbo == "dengue") %>%  
  mutate(epiweek = as.character(substr(SE,5,6)),
         ano = as.numeric(substr(SE,1,4)),
         pass = case_when(
  ano == ano_atual ~ 1,
  ano == ano_atual-1 ~ 2,
  TRUE ~ 3
)) %>% 
  ggplot(aes(x=epiweek))+
  geom_line(aes(y=p_inc100k, col = factor(pass), group = ano)) + 
  theme_minimal(base_size = 15) + 
  theme(
    axis.text.x = element_text(angle = 45, size = 12),
    legend.position = "top"
  ) +
  scale_color_manual(
    values = c("red","grey48",'grey'), labels = c("Esse ano","2024","10 últimos anos"), name = NULL
  ) +
  labs(
        x = "Semanas Epidemiológicas",
        y = "Incidência (casos por 100.000 hab.)",
        title = "Curva de incidência de dengue",
        subtitle = "Comparação do ano atual com anteriores"
      ) +
  scale_x_discrete(breaks = levels(
    factor(as.character(substr(dados_api$SE,5,6))))[seq(1, length(
      levels(factor(as.character(substr(dados_api$SE,5,6))))),
      by = 8)])
}

# CHIKON  
if (any(dados_api$arbo == "chikon", na.rm = TRUE)){
comp_mun_anos_chikon <- dados_api %>% filter(arbo == "chikon") %>% 
  mutate(epiweek = as.character(substr(SE,5,6)),
         ano = as.numeric(substr(SE,1,4)),
         pass = case_when(
  ano == ano_atual ~ 1,
  ano == ano_atual-1 ~ 2,
  TRUE ~ 3
)) %>% 
  ggplot(aes(x=epiweek))+
  geom_line(aes(y=p_inc100k, col = factor(pass), group = ano)) + 
  theme_minimal(base_size = 15) + 
  theme(
    axis.text.x = element_text(angle = 45, size = 12),
    legend.position = "top"
  ) +
  scale_color_manual(
    values = c("red","grey48",'grey'), labels = c("Esse ano","2024","5 últimos anos"), name = NULL
  ) +
  labs(
        x = "Semanas Epidemiológicas",
        y = "Incidência (casos por 100.000 hab.)",
        title = "Curva de incidência de chikungunya",
        subtitle = "Comparação do ano atual com anteriores"
      ) +
  scale_x_discrete(breaks = levels(
    factor(as.character(substr(dados_api$SE,5,6))))[seq(1, length(
      levels(factor(as.character(substr(dados_api$SE,5,6))))),
      by = 8)])
} else {
  comp_mun_anos_chikon <- NULL
}

## DISTRITO
comp_anos_distritos <- list()

combinacoes <- df_distritos %>%
  distinct(distrito, arbo)

for(i in 1:nrow(combinacoes)) {
  distrito_atual <- combinacoes$distrito[i]
  arbo_atual <- combinacoes$arbo[i]
  

  dados_filtrados <- df_distritos %>%
    filter(distrito == distrito_atual, arbo == arbo_atual)
  

  if(nrow(dados_filtrados) == 0) next
  

  titulo_arbo <- case_when(
    arbo_atual == "dengue" ~ "Dengue",
    arbo_atual == "chikon" ~ "Chikungunya",
    arbo_atual == "zikan" ~ "Zika",
    TRUE ~ "Arbovirose"
  )
  

  grafico <- dados_filtrados %>% 
    mutate(
      epiweek = as.character(substr(sem_not, 5, 6)),
      pass = case_when(
        ano == ano_atual ~ 1,
        ano == ano_atual - 1 ~ 2,
        TRUE ~ 3
      )
    ) %>% 
    ggplot(aes(x = epiweek)) +
    geom_line(aes(y = inc, col = factor(pass), group = ano)) + 
    theme_minimal(base_size = 15) + 
    theme(
      axis.text.x = element_text(angle = 45, size = 12),
      legend.position = "top"
    ) +
    scale_color_manual(
      values = c("red", "grey48", "grey"), 
      labels = c("Esse ano", "2024", "10 últimos anos"), 
      name = NULL
    ) +
    labs(
      x = "Semanas Epidemiológicas",
      y = "Incidência (casos por 100.000 hab.)",
      #title = paste("Comparação do ano atual com anteriores -", titulo_arbo),
      subtitle = distrito_atual
    ) +
    scale_x_discrete(
      breaks = function(x) x[seq(1, length(x), by = max(1, length(x) %/% 5))]
    )
  

  nome_grafico <- paste(distrito_atual, arbo_atual, sep = "_")
  comp_anos_distritos[[nome_grafico]] <- grafico
}

### RT

## MUNICIPIO

# DENGON
{
rt_mun_dengon <- create_rt_plot(
  api_data = dados_api %>% 
    filter(arbo == "dengue" & 
             SE >= paste0(ano_atual-1,substr(weeks_2_plot[3],5,6))), 
  weeks_limit = weeks_2_plot[3], 
  title_suffix = paste0("Curva de Rt dengue -  Joinville até ", weeks_2_plot[3]),
  sem_not = "SE"
)
}

# CHIKON
if (any(dados_api$arbo == "chikon", na.rm = TRUE)){
rt_mun_chikon <- create_rt_plot(
  api_data = dados_api %>% 
    filter(arbo == "chikon" & 
             SE >= paste0(ano_atual-1,substr(weeks_2_plot[3],5,6))), 
  weeks_limit = weeks_2_plot[3], 
  title_suffix = paste0("Curva de Rt chikungunya - Joinville até ", weeks_2_plot[3]),
  sem_not = "SE"
)
} else{
  rt_mun_chikon <- NULL
}

## DISTRITO

# DENGON
{
rt_distrito_dengon <- create_rt_plot(
  api_data = df_distritos %>% 
    filter(arbo == "dengue" & 
             sem_not >= paste0(ano_atual-1,substr(weeks_2_plot[3],5,6))), 
  weeks_limit = weeks_2_plot[3], 
  facet_by = "distrito",
  title_suffix = paste0("Curva de Rt dengue - Joinville até ", weeks_2_plot[3]),
  lwr = "lwr", upr = "upr"
)
}

# CHIKON
if (any(dados_api$arbo == "chikon", na.rm = TRUE)){
rt_distrito_chikon <- create_rt_plot(
  api_data = df_distritos %>% 
    filter(arbo == "chikon" & 
             sem_not >= paste0(ano_atual-1,substr(weeks_2_plot[3],5,6))), 
  weeks_limit = weeks_2_plot[3], 
  facet_by = "distrito",
  title_suffix = paste0("Curva de Rt chikungunya - Joinville até ", weeks_2_plot[3]),
  lwr = "lwr", upr = "upr",
  sem_not = "sem_not"
)
} else {
  rt_distrito_chikon <- NULL
}


### MAPAS 3 ULTIMAS SEMANAS

## DISTRITOS

# DENGON
jv_map_distritos_dengon <- create_map_panel(generate_maps(
  data = df_distritos, value_col = "inc",arbo = "dengue",
  weeks_2_plot = as.numeric(as.character(weeks_2_plot)))
)

# CHIKON
if (any(df_distritos$arbo == "chikon", na.rm = TRUE)){
jv_map_distritos_chikon <- create_map_panel(generate_maps(
  data = df_distritos, value_col = "inc",arbo = "chikon",
  weeks_2_plot = as.numeric(as.character(weeks_2_plot))
))} else{
  jv_map_distritos_chikon <- NULL
}

## BAIRROS

# DENGON
jv_map_bairros_dengon <- create_map_panel(generate_maps(
  data = df_bairros ,value_col = "inc", arbo = "dengue",
  weeks_2_plot = as.numeric(as.character(weeks_2_plot)),
  shape = df_distritos, area = "distrito"
))


# CHIKON
if (any(df_bairros$arbo == "chikon", na.rm = TRUE)){
jv_map_bairros_chikon <- create_map_panel(generate_maps(
  data = df_bairros, value_col = "inc", arbo = "chikon",
  weeks_2_plot = as.numeric(as.character(weeks_2_plot)),
  shape = df_distritos, area = "distrito"
))} else {
 jv_map_bairros_chikon <- NULL
}

### RECEPTIVIDADE CLIMATICA

jv_receptividade_climatica <- create_receptivity_plot(
  api_data = dados_api %>% 
    mutate(ano = as.numeric(substr(SE,1,4))) %>% 
    filter(arbo == "dengue" & ano %in% c(ano_atual-1,ano_atual)),
  weeks_limit = weeks_2_plot[3]
)

## JUNTANDO
mun_plots <- list(
  jv_inc_mun_dengon = jv_inc_mun_dengon,
  jv_inc_mun_chikon = jv_inc_mun_chikon,
  faixa_atividade_mun_dengon = faixa_atividade_mun_dengon,
  faixa_atividade_mun_chikon = faixa_atividade_mun_chikon,
  comp_mun_anos_dengon = comp_mun_anos_dengon,
  comp_mun_anos_chikon = comp_mun_anos_chikon,
  rt_mun_dengon = rt_mun_dengon,
  rt_mun_chikon = rt_mun_chikon,
  jv_receptividade_climatica = jv_receptividade_climatica
)

distrito_plots <- list(
  rt_distrito_dengon = rt_distrito_dengon,
  rt_distrito_chikon = rt_distrito_chikon,
  jv_map_distritos_chikon = jv_map_distritos_chikon,
  jv_map_distritos_dengon = jv_map_distritos_dengon)

bairros_plots <- list(
  jv_map_bairros_dengon = jv_map_bairros_dengon,
  jv_map_bairros_chikon = jv_map_bairros_chikon
)

perda_notificação <- df_bairros %>% 
  select(sem_not,casos,arbo) %>% 
  group_by(sem_not,arbo) %>% 
  summarise(notificações = sum(casos)) %>% 
   left_join(
    df_mun %>% 
      select(sem_not,nu_notific,arbo) %>% 
      mutate(sem_not = as.numeric(sem_not)) %>% 
      group_by(sem_not,arbo) %>% 
      summarise(notificações_bruto = n_distinct(nu_notific))
  ) %>% 
  mutate(notificações_bruto = ifelse(is.na(notificações_bruto),0,notificações_bruto),
         perca = abs(notificações_bruto - notificações),
         pct_perca = case_when(
           is.na(perca/notificações_bruto) ~ 0,
           TRUE ~ (perca/notificações_bruto)*100
         )) %>% 
  mutate(arbo = factor(arbo,levels = c("dengue","chikon"),
                       labels = c("dengue","chikungunya")))
```

```{r mapbiomas, include=FALSE}

mapbiomas <- terra::rast("./mapbiomas-brazil-collection-90-2023.tif")
mapbiomas2 <- as.data.frame(mapbiomas,xy=T)

mapbiomas2 <- mapbiomas2 %>% filter(classification_2023 != 0) %>%
  mutate(class = case_when(
    classification_2023 == 3 ~ "Formação Florestal",
    classification_2023 == 9 ~ "Agropecuária",
    classification_2023 == 21 ~ "Agropecuária",
    classification_2023 == 15 ~ "Agropecuária",
    classification_2023 == 41 ~ "Agropecuária",
    classification_2023 == 29 ~ "Afloramento Rochoso",
    classification_2023 == 39 ~ "Agropecuária",
    classification_2023 == 33 ~ "Rio, Lago e Oceano",
    classification_2023 == 49 ~ "Restinga Arbórea",
    classification_2023 == 5 ~ "Mangue",
    classification_2023 == 40 ~ "Agropecuária",
    classification_2023 == 25 ~ "Outras Áreas não Vegetadas",
    classification_2023 == 24 ~ "Área Urbanizada",
    classification_2023 == 30 ~ "Mineração",
    classification_2023 == 31 ~ "Aquicultura"
  ))

mapbiomas_colors <- c(
  "Formação Florestal" = "#1f8d49", 
  "Mangue" = "#04381d",    
  "Agropecuária" = "#ffefc3",    
  "Agropecuária" = "#ffefc3",   
  "Agropecuária" = "#ffefc3",  
  "Área Urbanizada" = "#d4271e",   
  "Outras Áreas não Vegetadas" = "#db4d4f",   
  "Afloramento Rochoso" = "#ffaa5f",  
  "Mineração" = "#9c0027",    
  "Aquicultura" = "#091077",    
  "Rio, Lago e Oceano" = "#2532e4",    
  "Agropecuária" = "#ffefc3",    
  "Agropecuária" = "#ffefc3",    
  "Agropecuária" = "#ffefc3",    
  "Restinga Arbórea" = "#02d659"     
)


jv_urbano <- jv_shp %>% sf::st_union() 
jv_bairros <- jv_shp %>% filter(
  nome_bairr %in% c("MORRO DO MEIO","RIO BONITO",
                    "PIRABEIRABA","VILA CUBATÃO",
                    "VILA NOVA")) %>% 
  select(geometry,nome_bairr)
```



```{r, include=FALSE, cache=FALSE}

# FIGURA 1 

fig1 <- mapbiomas2 %>% 
  filter(classification_2023 != 0) %>%
  ggplot() +
  geom_tile(aes(x = x, y = y, fill = class)) +
  geom_sf(
    data = jv_urbano, 
    alpha = 0, 
    linewidth = 0.8, 
    color = "black", 
    linetype = "solid"
  ) +
  geom_sf(
    data = jv_bairros,
    alpha = 0.6, 
    fill = "black"
  )+
  scale_fill_manual(
    values = mapbiomas_colors,
    name = "Uso do solo",
    na.value = "white",
    guide = guide_legend(nrow = 3, byrow = TRUE)
  ) +
  theme_minimal() +
  theme(legend.position = "top") +
  labs(x = "", y = "") +
  # Adicionando texto explicativo
  annotate(
    geom = "text",
    x = Inf, y = Inf,  # Canto superior direito
    label = "Linha preta: Limite urbano",
    hjust = 1.1,  # Ajuste horizontal (1 = direita), 
    vjust = 1,  # Ajuste vertical (1 = topo)
    size = 3.5,
    color = "black"
  )

ggsave("./plots/fig1.png",
       fig1,dpi = 600, bg = "white", width = 8, height = 7)


# FIGURA 2 

fig2 <- ggplot() +
  geom_sf(data = jv_mun_shape, 
          aes(geometry = geom, fill = "Região Rural"),
          color = "black"
) +
  geom_sf(
    data = df_bairros %>% st_as_sf() %>%
       filter(sem_not == weeks_2_plot[3] & arbo == "dengue"),
    aes(geometry = geometry, fill = distrito),
       color = "black", linewidth = 0.3
) + 
  ggpubr::theme_pubclean(
    base_size = 10
) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank()
) + 
  scale_fill_manual(
    name = "",
    values = c("Região Rural" = "white",
               "Distrito Centro" = "grey20",
               "Distrito Norte" = "grey50", 
               "Distrito Sul" = "grey70")
)

ggsave("./plots/fig2.png",
       fig2,width = 7,
       height = 5,
       dpi = 600, bg = "white")

# FIGURA 3

fig3 <- df_mun_miss %>% 
  filter(sem_not >= 202401) %>% 
  select(sem_not,arbo,perc_na_id,perc_na_nome) %>% 
  #mutate(ano = substr(sem_not,1,4)) %>%
  pivot_longer(cols = 3:4, names_to = "var",
               values_to = "n") %>%
  mutate(var = case_when(
    var == "perc_na_id" ~ "ID_BAIRRO",
    var == "perc_na_nome" ~ "NM_BAIRRO"),
    arbo = ifelse(arbo == "chikon","chikungunya",arbo),
    arbo = factor(arbo, levels = c("dengue","chikungunya")),
    ew = substr(sem_not,5,6),
    ano = substr(sem_not,1,4)) %>%
  complete(
    ew = sprintf("%02d", 1:52),
    ano = as.character(2024:2025),
    arbo = c("dengue","chikungunya"),
    var = c("ID_BAIRRO","NM_BAIRRO"),
    fill = list( # preencher outras colunas com valores padrão
      n = NA
    )
  ) %>% 
  filter(ano == ano_atual) %>% 
  ggplot()+
  geom_hline(yintercept = 70, linetype = "dashed", color = "black") +
  geom_point(aes(x = factor(ew), y = 100-n , col = var, group = var), alpha = 1)+
  # geom_line(aes(x=factor(ew), y = 100-n, group = var)) +
  geom_text(aes(label="Quantidade mínima", x = 10, y = 65)) +
  theme_minimal(base_size = 11)+
  labs(y = "% de completude", x = "Semanas Epidemiológicas", col = "",
       title = )+
  scale_color_manual(values=c("blue3","red3"))+
  theme(axis.text.x = element_text(angle = 60,hjust = 1),
        axis.text  = element_text(colour = "black"),
        legend.position = "top") +
   facet_wrap(~arbo, ncol = 1)


 ggsave("./plots/fig3.png",
        fig3,dpi = 300,
        width = 7.5, height = 6,
        bg = "white")
 
 
# FIGURA 4 
 
 ## MUNICIPIO 
fig4 <- perda_notificação %>% 
  filter(sem_not >= paste0(ano_atual-1,substr(weeks_2_plot[3],5,6))) %>% 
  ggplot() + 
  geom_line(aes(x=factor(sem_not), y = perca, group = 1, col = "Perdidos")) + 
  geom_line(aes(x=factor(sem_not), y = notificações, group = 1, col = "Notificações")) +
  labs(x = "Semanas Epidemiológicas", 
       y = "Casos", colour = "") +
  scale_color_manual(values = c("black","red")) +
  scale_x_discrete(breaks = levels(factor(df_mun$sem_not))[seq(1, length(levels(factor(df_mun$sem_not))), by = 8)]) + 
  theme_minimal(base_size = 11) +
  theme(axis.text.x = element_text(angle = 60,hjust = 1),
        legend.position = "top") +
  facet_wrap(~arbo, scale = "free", ncol = 1)  

ggsave("./plots/fig4.png",
        fig4,dpi = 600,
        width = 7, height = 5,
        bg = "white") 
 

# FIGURA 5

fig5 <- ggarrange(
  mun_plots$jv_inc_mun_dengon,
  mun_plots$jv_inc_mun_chikon,
  ncol = 1, 
  labels = letters[1:2]
)

ggsave("./plots/fig5.png", fig5,
       width = 7, height = 7.5, dpi = 600)

# FIGURA 6

fig6 <- mun_plots$jv_receptividade_climatica

# FIGURA 7

fig7 <- ggarrange(
  mun_plots$comp_mun_anos_dengon,
  mun_plots$comp_mun_anos_chikon,
  ncol = 1, 
  labels = letters[1:2]
)

ggsave("./plots/fig7.png", fig7,
       width = 7, height = 9, dpi = 600, bg = "white")

# FIGURA 8

fig8 <- ggarrange(
  mun_plots$rt_mun_dengon,
  mun_plots$rt_mun_chikon,
  ncol = 1, 
  labels = letters[1:2]
)

ggsave("./plots/fig8.png", fig8,
       width = 7, height = 9, dpi = 600, bg = "white")

# FIGURA 9

fig9 <- ggarrange(
  jv_inc_distritos_dengon[[1]] + ylim(0,500),
  jv_inc_distritos_dengon[[2]] + ylim(0,500),
  jv_inc_distritos_dengon[[3]] + ylim(0,500),
  ncol = 1
)

ggsave("./plots/fig9.png", fig9,
       width = 7, height = 11, dpi = 600, bg = "white")

# FIGURA 10
fig10 <- distrito_plots$jv_map_distritos_dengon

ggsave("./plots/fig10.png", fig10,
       width = 8, height = 9, dpi = 600, bg = "white")

# FIGURA 11
fig11 <- ggarrange(
  jv_inc_distritos_chikon[[1]],
  jv_inc_distritos_chikon[[2]],
  jv_inc_distritos_chikon[[3]],
  ncol = 1
)

ggsave("./plots/fig11.png", fig11,
       width = 7, height = 11, dpi = 600, bg = "white")

# FIGURA 12
fig12 <- distrito_plots$jv_map_distritos_chikon

ggsave("./plots/fig12.png", fig12,
       width = 8, height = 9, dpi = 600, bg = "white")

# FIGURA 13

fig13 <- ggplot() +
  geom_rect(data = dados_api %>% 
      filter(SE %in% as.numeric(ultimas_semanas)) %>% 
      group_by(SE),
            aes(xmin = as.numeric(factor(SE)) - 0.5, 
                  xmax = as.numeric(factor(SE)) + 0.5, 
                  ymin = -Inf, 
                  ymax = Inf, 
                  fill = tempmin >= 18), alpha = 0.7) +
      scale_fill_manual(values = c("TRUE" = "steelblue", "FALSE" = "grey70"), guide = "none") +
  geom_line(
    data = dados_api %>% 
      filter(SE %in% as.numeric(ultimas_semanas)) %>% 
      group_by(SE) %>% 
      summarise(tempmin = mean(tempmin)),
    aes(x = factor(SE), y = tempmin, group = 1, col = "Município")
  ) +
  geom_line(
    data = distrito_downsc %>% 
      mutate(ano = as.numeric(substr(SE,1,4))) %>% 
      filter(SE %in% ultimas_semanas),
    aes(factor(SE), mean_pred, group = Distrito, color = Distrito)
  ) +
  geom_ribbon(
    data = distrito_downsc %>% 
      mutate(ano = as.numeric(substr(SE,1,4))) %>% 
      filter(SE %in% ultimas_semanas),
    aes(factor(SE),
        ymin = mean_ll,
        ymax = pred_ul, group = Distrito, fill = Distrito),
    alpha = 0.2, show.legend = F
  ) + 
  geom_hline(aes(yintercept = 18), 
             linewidth = 1, linetype = "dashed", show.legend = F, col = "red") +
  scale_color_manual(values = c("blue","salmon","green3","orange2")) +
  scale_y_continuous(
    name = "Receptividade climática") +
  theme_minimal() +
  theme(
    axis.title.y.right = element_text(color = "black"),
    axis.text.y.right = element_text(color = "black"),
    axis.title.y.left = element_text(color = "black"),
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) + 
  labs(x = "Semanas Epidemiológicas", 
       y = "Temp. Mínima",
       title = "Distritos - últimas 5 semanas", 
       color = "") +
  scale_x_discrete(expand = c(0,0))

ggsave("./plots/fig13.png", fig13,
       width = 7, height = 5, dpi = 600, bg = "white")


# FIGURA 14
comp_coluna_dengue <- ggarrange(
  comp_anos_distritos$`Distrito Centro_dengue` + rremove("ylab") + rremove("xlab"),
  comp_anos_distritos$`Distrito Norte_dengue` + rremove("ylab") + rremove("xlab"),
  comp_anos_distritos$`Distrito Sul_dengue` + rremove("ylab") + rremove("xlab"),
  nrow = 3,
  labels = letters[1:3],  # Letras a, b, c
  font.label = list(size = 12, face = "bold")
) %>% 
  annotate_figure(top = text_grob("Dengue", face = "bold", size = 14))

comp_coluna_chik <- ggarrange(
  comp_anos_distritos$`Distrito Centro_chikon` + rremove("ylab") + rremove("xlab"),
  comp_anos_distritos$`Distrito Norte_chikon` + rremove("ylab") + rremove("xlab"),
  comp_anos_distritos$`Distrito Sul_chikon` + rremove("ylab") + rremove("xlab"),
  nrow = 3,
  labels = letters[4:6],  # Letras d, e, f
  font.label = list(size = 12, face = "bold")
) %>% 
  annotate_figure(top = text_grob("Chikungunya", face = "bold", size = 14))


fig14 <- ggarrange(
  comp_coluna_dengue, 
  comp_coluna_chik,
  ncol = 2
)

fig14 <- annotate_figure(
  fig14,
  left = text_grob("Incidência (casos por 100.000 hab", rot = 90, size = 12),
  bottom = text_grob("Semanas epidemiológicas", size = 12)
)

ggsave("./plots/fig14.png", fig14,
       width = 8, height = 9, dpi = 600, bg = "white")

# FIGURA 15

fig15 <- distrito_plots$rt_distrito_dengon

ggsave("./plots/fig15.png", fig15,
       width = 7, height = 6, dpi = 600, bg = "white")

# FIGURA 16

fig16 <- distrito_plots$rt_distrito_chikon

ggsave("./plots/fig16.png", fig16,
       width = 7, height = 6, dpi = 600, bg = "white")

# FIGURA 17
fig17 <- ggarrange(
  jv_inc_bairros_dengon[[1]],
  jv_inc_bairros_dengon[[2]],
  jv_inc_bairros_dengon[[3]],
  ncol = 1
)

ggsave("./plots/fig17.png", fig17,
       width = 7, height = 11, dpi = 600, bg = "white")

# FIGURA 18
fig18 <- jv_map_bairros_dengon

ggsave("./plots/fig18.png", fig18,
       width = 9, height = 9, dpi = 600, bg = "white")

# FIGURA 19
fig19 <- ggarrange(
  jv_inc_bairros_chikon[[1]],
  jv_inc_bairros_chikon[[2]],
  jv_inc_bairros_chikon[[3]],
  ncol = 1
)

ggsave("./plots/fig19.png", fig19,
       width = 7, height = 11, dpi = 600, bg = "white")

# FIGURA 20
fig20 <- jv_map_bairros_chikon

ggsave("./plots/fig20.png", fig20,
       width = 9, height = 9, dpi = 600, bg = "white")

```

```{r cache=FALSE, include=FALSE}

# TABELA 1

tab1_ok <- perda_notificação %>% 
  filter(sem_not %in% weeks_2_plot) %>% 
  arrange(desc(sem_not),arbo) %>% 
  ungroup() %>% 
  select(sem_not,arbo,notificações,perca,pct_perca) %>% 
  mutate(pct_perca = round(pct_perca,2)) %>% 
  gt(groupname_col = "arbo") %>% 
  cols_label(
    sem_not = "SE",
    arbo = "Arbovirose",
    notificações = "Casos notificados",
    perca = "Casos perdidos",
    pct_perca = "% perdidos"
  ) %>% 
  tab_options(
    table.font.size = "14px"
  ) %>% 
   tab_style(
    style = cell_text(align = "center", v_align = "middle"),  
    locations = list(
      cells_body(),          
      cells_column_labels()  
    )
  ) 

# TABELA 2
tab2_dengon <- dados_api %>% 
  filter(arbo == "dengue" & SE %in% weeks_2_plot) %>% 
  left_join(jv_mun_nowscat$mun_nowcast %>% 
              select(ano_epi,Median) %>% 
              mutate(ano_epi = as.numeric(ano_epi)),
            by = c("SE" = "ano_epi")) %>% 
  mutate(arbo = "dengue",
         receptivo = case_when(
           receptivo == 0 ~ "baixa",
           TRUE ~ "alta"),
         nivel = case_when(
         nivel == 1 ~ "verde",
         nivel == 2 ~ "amarelo",
         nivel == 3 ~ "laranja",
         nivel == 4 ~ "vermelho"),
         p_inc100k = round(p_inc100k,1)) %>% 
  select(arbo, SE, casos, Median, p_inc100k, receptivo, nivel)

casos_acumulado_municipio_dengon_ultimasSE <- 
  dados_api %>% 
  filter(substr(SE,1,4) == ano_atual & arbo == "dengue") %>% 
  select(SE, casos) %>%
  arrange(SE) %>%  # Ordenar por semana epidemiológica
  mutate(acumulado = cumsum(casos)) %>% 
  filter(SE %in% weeks_2_plot) %>% 
  mutate(arbo = "dengue") %>% 
  arrange(desc(SE))

casos_acumulado_municipio_chikon_ultimasSE <- 
  dados_api %>% 
  filter(substr(SE,1,4) == ano_atual & arbo == "chikon") %>% 
  select(SE, casos) %>%
  arrange(SE) %>%  # Ordenar por semana epidemiológica
  mutate(acumulado = cumsum(casos)) %>% 
  filter(SE %in% weeks_2_plot) %>% 
  mutate(arbo = "chikungunya") %>% 
  arrange(desc(SE))
      
      

tab2_chikon <- dados_api %>% 
  filter(arbo == "chikon" & SE %in% weeks_2_plot) %>% 
  # left_join(jv_mun_nowscat$mun_nowcast %>% 
  #             select(ano_epi,Median) %>% 
  #             mutate(ano_epi = as.numeric(ano_epi)),
  #           by = c("SE" = "ano_epi")) %>% 
  mutate(arbo = "chikungunya",
         receptivo = case_when(
           receptivo == 0 ~ "baixa",
           TRUE ~ "alta"),
         nivel = case_when(
         nivel == 1 ~ "verde",
         nivel == 2 ~ "amarelo",
         nivel == 3 ~ "laranja",
         nivel == 4 ~ "vermelho"),
         Median = 0,
         p_inc100k = round(p_inc100k,1)) %>% 
  select(arbo, SE, casos, Median, p_inc100k, receptivo, nivel)  


tab2 <- rbind(tab2_dengon,tab2_chikon) %>% 
  mutate(acumulado = c(casos_acumulado_municipio_dengon_ultimasSE$acumulado,
                           casos_acumulado_municipio_chikon_ultimasSE$acumulado)) %>% 
  select(SE,arbo,acumulado,casos,Median,p_inc100k,nivel)

tab2_ok <- tab2 %>%
  gt(groupname_col = "arbo") %>%
  fmt_number(columns = c(casos, Median, p_inc100k), decimals = 0) %>%
  cols_label(
    arbo = "Arbovirose",
    acumulado = "Casos acumulados",
    casos = "Casos notificados",
    Median = "Casos estimados",
    p_inc100k = "Incidência (por 100 mill hab.)",
    nivel = "Nível"
  ) %>%
  tab_options(
    table.font.size = "14px"
  ) %>% 
   tab_style(
    style = cell_text(align = "center", v_align = "middle"),  
    locations = list(
      cells_body(),          
      cells_column_labels()  
    )
  ) %>% 
   tab_style(
    style = cell_text(color = "green", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "verde")
  ) %>%
  tab_style(
    style = cell_text(color = "gold", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "amarelo")
  ) %>%
  tab_style(
    style = cell_text(color = "darkorange", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "laranja")
  ) %>%
  tab_style(
    style = cell_text(color = "red", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "vermelho")
  ) %>% 
  tab_header(title = md(""),
              subtitle = md(""))

# TABELA 3
casos_acumulados_distrito_dengon <- df_distritos %>% 
  filter(substr(sem_not, 1, 4) == ano_atual & arbo == "dengue") %>% 
  select(sem_not, casos, distrito) %>%
  arrange(sem_not, distrito) %>%  
  group_by(distrito) %>%  # Agrupa por distrito
  mutate(acumulado = cumsum(casos)) %>% 
  filter(sem_not %in% weeks_2_plot) %>% 
  arrange(distrito,desc(sem_not))
  

distritoCentro_estimados_dengon <- jv_distritos_nowcast$`Distrito Centro`$nowcast$total %>% 
  filter(ano_epi %in% weeks_2_plot) %>% 
  select(ano_epi, Median) %>% 
  mutate(distrito = "Distrito Centro")

distritoNorte_estimados_dengon <- jv_distritos_nowcast$`Distrito Norte`$nowcast$total %>% 
  filter(ano_epi %in% weeks_2_plot) %>% 
  select(ano_epi, Median) %>% 
  mutate(distrito = "Distrito Norte")


distritoSul_estimados_dengon <- jv_distritos_nowcast$`Distrito Sul`$nowcast$total %>% 
  filter(ano_epi %in% weeks_2_plot) %>% 
  select(ano_epi, Median) %>% 
  mutate(distrito = "Distrito Sul")

distritos_estimados_dengon <- rbind(
  distritoCentro_estimados_dengon,
  distritoNorte_estimados_dengon,
  distritoSul_estimados_dengon
  
)

tab3 <- df_distritos %>% 
  #mutate(ew = substr(sem_not,5,6)) %>%
  filter(arbo == "dengue" &
           ano == ano_atual  &
           sem_not %in% weeks_2_plot) %>%
  group_by(sem_not,distrito) %>% arrange(desc(sem_not)) %>% 
  summarise(casos_notificados = sum(casos),
            nivel = sum(nivel))  %>% 
  mutate(pop = populacoes_distritos,
         inc = casos_notificados/pop * 1e5) %>% 
  left_join(distritos_estimados_dengon %>% 
              mutate(ano_epi= as.numeric(ano_epi)),
            by = c("sem_not" = "ano_epi", "distrito")) %>% 
  select(sem_not,distrito,casos_notificados,Median,inc,nivel) %>% 
  mutate(
    nivel = case_when(
      nivel == 1 ~ "verde",
      nivel == 2 ~ "amarelo",
      nivel == 3 ~ "laranja",
      nivel == 4 ~ "vermelho"
    ),
    sem_not = as.numeric(as.character(sem_not)),
    distrito = factor(distrito)
  ) %>% 
  left_join(casos_acumulados_distrito_dengon %>% 
              select(sem_not, distrito, acumulado)) %>% 
  select(sem_not, acumulado, casos_notificados, Median, inc, nivel, distrito)
  
tab3_ok <- tab3 %>% ungroup() %>% 
  arrange(desc(sem_not)) %>% 
  gt(groupname_col = "distrito") %>%
  #fmt_number(columns = c(casos_notificados, Median, inc), decimals = 0) %>%
  cols_label(
    sem_not = "SE",
    acumulado = "Casos acumulados",
    casos_notificados = "Casos notificados",
    distrito = "Distrito",
    Median = "Casos estimados",
    inc = "Incidência",
    nivel = "Nível"
  ) %>%
  tab_options(
    table.font.size = "14px"
  ) %>% 
   tab_style(
    style = cell_text(align = "center", v_align = "middle"),  
    locations = list(
      cells_body(),          
      cells_column_labels()  
    )
  ) %>% 
   tab_style(
    style = cell_text(color = "green", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "verde")
  ) %>%
  tab_style(
    style = cell_text(color = "gold", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "amarelo")
  ) %>%
  tab_style(
    style = cell_text(color = "darkorange", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "laranja")
  ) %>%
  tab_style(
    style = cell_text(color = "red", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "vermelho")
  ) %>% 
  tab_header(title = md(""),
              subtitle = md(""))

# TABELA 4 
casos_acumulados_distrito_chikon <- df_distritos %>% 
  filter(substr(sem_not, 1, 4) == ano_atual & arbo == "chikon") %>% 
  select(sem_not, casos, distrito) %>%
  arrange(sem_not, distrito) %>%  
  group_by(distrito) %>%  # Agrupa por distrito
  mutate(acumulado = cumsum(casos)) %>% 
  filter(sem_not %in% weeks_2_plot) %>% 
  arrange(distrito,desc(sem_not))


tab4 <- df_distritos %>%
  #mutate(ew = substr(sem_not,5,6)) %>%
  filter(arbo == "chikon" &
           ano == ano_atual  &
           sem_not %in% weeks_2_plot) %>%
  group_by(sem_not,distrito) %>% arrange(desc(sem_not)) %>%
  summarise(casos_notificados = sum(casos),
            nivel = sum(nivel))  %>%
  mutate(pop = populacoes_distritos,
         inc = casos_notificados/pop * 1e5) %>%
  # left_join(distritos_estimados_dengon %>%
  #             mutate(ano_epi= as.numeric(ano_epi)),
  #           by = c("sem_not" = "ano_epi", "distrito")) %>%
  select(sem_not,distrito,casos_notificados,inc,nivel) %>%
  mutate(
    nivel = case_when(
      nivel == 1 ~ "verde",
      nivel == 2 ~ "amarelo",
      nivel == 3 ~ "laranja",
      nivel == 4 ~ "vermelho"
    ),
    sem_not = as.numeric(as.character(sem_not)),
    distrito = factor(distrito)
  ) %>% 
  left_join(casos_acumulados_distrito_chikon %>% 
              select(sem_not, distrito, acumulado)) %>% 
  select(sem_not, acumulado, casos_notificados, inc, nivel, distrito)

tab4_ok <- tab4 %>% ungroup() %>%
  arrange(desc(sem_not)) %>%
  gt(groupname_col = "distrito") %>%
  #fmt_number(columns = c(casos_notificados, Median, inc), decimals = 0) %>%
  cols_label(
    sem_not = "SE",
    acumulado = "Casos acumulados",
    casos_notificados = "Casos notificados",
    distrito = "Distrito",
    inc = "Incidência",
    nivel = "Nível"
  ) %>%
  tab_options(
    table.font.size = "14px"
  ) %>%
   tab_style(
    style = cell_text(align = "center", v_align = "middle"),
    locations = list(
      cells_body(),
      cells_column_labels()
    )
  ) %>%
   tab_style(
    style = cell_text(color = "green", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "verde")
  ) %>%
  tab_style(
    style = cell_text(color = "gold", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "amarelo")
  ) %>%
  tab_style(
    style = cell_text(color = "darkorange", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "laranja")
  ) %>%
  tab_style(
    style = cell_text(color = "red", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "vermelho")
  ) %>%
  tab_header(title = md(""),
              subtitle = md(""))

# TABELA 5

tab5 <- bairros_ultima_semana_dengue %>% 
  mutate(
    inc = round(inc,1),
    Rt = round(Rt,1),
    nivel = case_when(
      nivel == 1 ~ "verde",
      nivel == 2 ~ "amarelo",
      nivel == 3 ~ "laranja",
      nivel == 4 ~ "vermelho"
    )
  ) %>% arrange(desc(inc))

tab5_ok <- tab5 %>% ungroup() %>% 
  gt(groupname_col = "distrito") %>%
  #fmt_number(columns = c(casos_notificados, Median, inc), decimals = 0) %>%
  cols_label(
    nm_bairro_ref = "Bairro",
    casos = "Casos notificados",
    distrito = "Distrito",
    inc = "Incidência",
    nivel = "Nível",
    semanas_com_nivel3_4 = html("Semanas com nível crítico<br>(janela de 5 últimas semanas)")
  ) %>%
  tab_options(
    table.font.size = "14px"
  ) %>% 
   tab_style(
    style = cell_text(align = "center", v_align = "middle"),  
    locations = list(
      cells_body(),          
      cells_column_labels()  
    )
  ) %>% 
   tab_style(
    style = cell_text(color = "green", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "verde")
  ) %>%
  tab_style(
    style = cell_text(color = "gold", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "amarelo")
  ) %>%
  tab_style(
    style = cell_text(color = "darkorange", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "laranja")
  ) %>%
  tab_style(
    style = cell_text(color = "red", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "vermelho")
  ) %>% 
  tab_header(title = md("dengue"),
              subtitle = md(""))
  

# TABELA 6

tab6 <- bairros_ultima_semana_chikon %>%
  mutate(
    inc = round(inc,1),
    Rt = round(Rt,1),
    nivel = case_when(
      nivel == 1 ~ "verde",
      nivel == 2 ~ "amarelo",
      nivel == 3 ~ "laranja",
      nivel == 4 ~ "vermelho"
    )
  ) %>% arrange(desc(inc))

tab6_ok <- tab6 %>% ungroup() %>%
  gt(groupname_col = "distrito") %>%
  #fmt_number(columns = c(casos_notificados, Median, inc), decimals = 0) %>%
  cols_label(
    nm_bairro_ref = "Bairro",
    casos = "Casos notificados",
    distrito = "Distrito",
    inc = "Incidência",
    nivel = "Nível",
    semanas_com_nivel3_4 = html("Semanas com nível crítico<br>(janela de 5 últimas semanas)")
  ) %>%
  tab_options(
    table.font.size = "14px"
  ) %>%
   tab_style(
    style = cell_text(align = "center", v_align = "middle"),
    locations = list(
      cells_body(),
      cells_column_labels()
    )
  ) %>%
   tab_style(
    style = cell_text(color = "green", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "verde")
  ) %>%
  tab_style(
    style = cell_text(color = "gold", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "amarelo")
  ) %>%
  tab_style(
    style = cell_text(color = "darkorange", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "laranja")
  ) %>%
  tab_style(
    style = cell_text(color = "red", weight = "bold"),
    locations = cells_body(
      columns = nivel,
      rows = nivel == "vermelho")
  ) %>%
  tab_header(title = md("chikungunya"),
              subtitle = md(""))

```

```{r, objetos_texto, include=FALSE}
casos_acumulado_atual_dengon <- dados_api %>% 
  filter(substr(SE,1,4) == ano_atual) %>% 
  pull(casos) %>% sum()


inc_acumulado_dengon <- round(casos_acumulado_atual_dengon/616317*1e5,1)
week_atual <- paste0("SE", substr(weeks_2_plot[3],5,6))

ultimas_3_semanas <- paste0("SE","",as.character((substr(weeks_2_plot,5,6))))
```

# Joinville - SC

## Contextualização do município e processamento

O município de Joinville (SC) é o mais populoso do estado (616.317 habitantes) e possui oficialmente 43 bairros em sua extensão urbana. O uso do espaço urbano de acordo com o uso do solo pode ser observado na figura 1.

```{r fig1, echo=FALSE, fig.cap="Figura 1: Descrição do espaço urbano do município de Joinville de acordo com o uso do solo."}
fig1

```

O presente boletim apresenta análises realizadas nos níveis municipal, de distritos e bairros. Os distritos foram agregados com base na intersecção dos bairros com os três distritos de abrangência das Unidades Básicas de Saúde (UBS): Distrito Centro, Distrito Norte e Distrito Sul (Figura 2). Não capturamos a dinâmica da região rural do município devido a inexistência de informações precisas referentes a localidade das notificações nesta região, no entanto, os bairros Morro do Meio, Rio Bonito, Pirabeiraba, Vila Cubatão e Vila Nova frequentemente incorporam os casos que são associados à região rural.

```{r fig2, echo=FALSE, fig.cap="Figura 2: Demarcação do ambiente urbano com bairros e distritos."}
fig2

```

Para a realização das análises foram utilizados os dados do SINAN Online agregados em três níveis: municipal, distrito de saúde e bairro. A agregação dos casos por bairro utilizou a variável “NM_BAIRRO”, pois esta apresentou a maior completude (superior ou igual a 70%) durante o processo de avaliação prévia dos dados (Figuras 3). Primeiramente foi realizada padronização dos nomes devido a diferentes grafias ou erros de escrita e remoção das notificações as quais os nomes dos bairros divergiam muito da grafia oficial ou que não constavam da lista dos 43 bairros oficiais. Além disso, para correta agregação dos casos por bairro também foram utilizados os arquivos shapefile dos bairros e distritos, dados populacionais para bairros e a listagem do nome dos bairros padronizada e correta.


## Análise da qualidade dos dados para geolocalização

Para a realização das análises foram utilizados os dados do SINAN Online agregados em três níveis: municipal, distrito de saúde e bairro.  A agregação dos casos por bairro utilizou a variável “NM_BAIRRO”, pois esta apresentou a  maior completude (superior ou igual a 70%) durante o processo de avaliação prévia dos dados (Figura 3). Primeiramente foi realizada padronização dos nomes devido a diferentes grafias ou erros de escrita e remoção das notificações as quais os nomes dos bairros divergiam muito da grafia oficial ou que não constavam da lista dos 43 bairros oficiais. Além disso, para correta agregação dos casos por bairro também foram utilizados os arquivos shapefile dos bairros e distritos, dados populacionais para bairros e a listagem do nome dos bairros padronizada e correta.

```{r fig3, echo=FALSE, fig.cap=paste0("Figura 3: Completude dos dados notificados de Dengue (A) e Chikungunya (B) até a ", week_atual), warning=FALSE}
fig3

```

A tabela 1 apresenta as informações sobre o número de casos notificados perdidos e o seu percentual em relação ao número de casos totais nas últimas 3 semanas epidemiológicas para dengue e chikungunya. Os casos perdidos correspondem às notificações que não puderam ser alocadas em um determinado bairro devido à falta de preenchimento da variável NM_BAIRRO ou do seu preenchimento com informações muito divergentes à lista de referência (composta por 43 bairros oficiais) e/ou não possuía o preenchimento da variável “ID_BAIRRO”. A figura 4 mostra  a informação perdida na série temporal do ano passado e ano atual.


```{r echo=FALSE}
tab1_ok
```


```{r echo=FALSE, fig.cap=paste0("Figura 4: Número de dados notificados e perdidos de dengue (A) e chikungunya (B) até a ", week_atual)}
fig4

```

## Análise da situação das arboviroses 

Esse boletim analisa as condições de transmissão das arboviroses  utilizando dados de clima (Copernicus ERA 5) e de notificação de casos (SINAN) fornecidos semanalmente pela CGARB/SVS/MS. A partir desses dados são analisadas as condições de receptividade climática, transmissão e incidência (ver descrição no final do relatório), tendo como objetivo contribuir para a tomada de decisão na sala de situação.
A seguir, são apresentados os resultados das análises em três níveis espaciais: nível do município, distritos e bairros.

## Limiar epidêmico

A tabela abaixo categoriza a incidência do município quanto ao limiar epidêmico estabelecido utilizando dados históricos. Valores superiores à 72,4 casos por 100 mil habitantes indicam o estabelecimento de uma epidemia.

## Situação recente das Arboviroses a nível do município


Esse ano foram notificados até o momento, `r casos_acumulado_atual_dengon` casos das arboviroses monitoradas, o que corresponde a uma incidência acumulada de `r inc_acumulado_dengon` casos por 100.000 habitantes. Esse valor corresponde a 14,8 % do registrado no ano passado, no mesmo período.

## Casos notificados, incidência e variação de casos

A tabela abaixo sumariza, em relação às últimas 3 semanas epidemiológicas (`r ultimas_3_semanas`), o número de casos observados, casos estimados, a incidência por 100 mil habitantes, o total de casos acumulados e o nível de alerta calculados.

```{r tab1, echo=FALSE, out.width="100%"}
tab2_ok


```

A figuras 5 mostra o perfil de incidência de dengue e chikungunya na cidade e as cores indicam o nível de atenção da semana epidemiológica. A descrição do código de cores e a relação entre o nível de atenção do Infodengue com o nível de atenção do Plano de Contingência Nacional estão descritos na tabela em anexo.

```{r fig5, echo=FALSE, fig.cap=paste0("Figura 5: Curva de incidência de Dengue (A) e Chikungunya (B) - Joinville/SC até a", week_atual, ". A linha azul representa o número de casos observados e a linha vermelha horizontal o limiar epidêmico (incidência superior a 72,4 casos por 100 mil habitantes)."), fig.height=8}
fig5

```

## Perfil sazonal da receptividade climática 

O perfil sazonal da receptividade climática no município para a transmissão das arboviroses é calculado a partir dos dados meteorológicos e indicam períodos do ano em que há maior risco de transmissão de arboviroses. A figura 6 apresenta uma escala de receptividade que varia de 0 (período pouco receptivo) a 100 (período muito receptivo) sendo que, períodos muito receptivos, marcam a sazonalidade da doença. Observa-se que o período receptivo típico no município ocorre entre as semanas 45 e 15, que corresponde ao período com temperaturas mínimas acima de 18 graus.


```{r echo=FALSE, fig.cap = paste0("Figura 6: Receptividade climática e temperatura  mínima do município até a ", week_atual, ".A linha amarela corresponde à variação da temperatura mínima durante o período. A área azul corresponde a período com receptividade climática favorável à transmissão de arboviroses, enquanto a área cinza a receptividade abaixo do limiar favorável.")}

fig6 

```


## Comparação da sazonalidade atual com anos anteriores

O perfil sazonal das séries temporais de incidência de casos de dengue e chikungunya nos últimos 10 e 5 anos, respectivamente, estão representadas na figura 7 e podem ser comparadas com a incidência desse ano (marcado em vermelho).

```{r fig7, echo=FALSE, fig.cap="Comparação da incidência do ano atual com anteriores para dengue (A) e chikungunya (B)", fig.height=6, message=FALSE, warning=FALSE}
fig7

```

## Número reprodutivo

O perfil de transmissibilidade da dengue (figura 8) é medido pelo número reprodutivo, Rt. Valores dessa métrica maiores que 1 ou mais de 3 semanas seguidas indicam transmissão sustentada de dengue (figura 8A) ou chikungunya (figura 8B).

```{r, echo=FALSE, fig.cap=paste0("Figura 8: Número reprodutivo semanal de Dengue (A) e Chikungunya (B) para o município estimado até a ", week_atual)}
fig8
```


# Situação das Arboviroses nos Distritos de Saúde

## Casos notificados, incidência e variação de casos

### Dengue

A tabela abaixo sumariza, em relação às últimas 3 semanas epidemiológicas (`r ultimas_3_semanas`) e para cada distrito, o número de casos observados, casos estimados, a incidência por 100 mil habitantes, o total de casos acumulados e o nível de alerta calculados.


```{r tab3, echo=FALSE}
tab3_ok


```

A figuras 9 mostra o perfil de incidência de dengue nos Distritos de Saúde e as cores indicam o nível de atenção da semana epidemiológica. O código de cores indica o nível de alerta da semana epidemiológica. 

```{r fig9, echo=FALSE, fig.cap=paste0("Figura 9: Curva de incidência de Dengue para os Distritos Centro, Norte e Sul até a", week_atual, "A linha azul representa o número de casos notificados e a linha vermelha horizontal o limiar epidêmico (incidência superior a 72,4 casos por 100 mil habitantes)."), fig.height=11}
fig9

```

A figura 10 ilustra a incidência por 100 mil habitantes dos casos notificados de dengue agregados pelos Distrito de Saúde em Joinville, entre as `r ultimas_3_semanas` de `r ano_atual` . Para cada semana é apresentada a porcentagem de casos notificados que não puderam ser alocados em nenhum Distrito de Saúde devido a problemas no preenchimento ou ausência de informação sobre o local de ocorrência dos casos.


```{r fig10, echo=FALSE, fig.cap="Figura 10: Incidência de dengue (casos por 100.000 habitantes) nos distritos nas últimas 3 semanas epidemiológicas", fig.height=8}
fig10

```

### Chikungunya

A tabela abaixo sumariza, em relação às últimas 3 semanas epidemiológicas (`r ultimas_3_semanas`)  e para cada distrito, o número de casos observados, casos estimados, a incidência por 100 mil habitantes, o total de casos acumulados e o nível de alerta calculados.


```{r tab8, echo=FALSE}
tab4_ok

```

A figura 11 mostra o perfil de incidência de chikungunya nos Distritos de Saúde e as cores indicam o nível de atenção da semana epidemiológica. O código de cores indica o nível de alerta da semana epidemiológica. 


```{r fig11, echo=FALSE, fig.cap="Figura 13: Incidência de Chikungunya (casos por 100.000 habitantes) nos distritos nas últimas 3 semanas epidemiológicas. A linha azul representa o número de casos notificados.", fig.height=8}
fig11

```

A figura 12 ilustra a incidência por 100 mil habitantes dos casos notificados de chikungunya agregados pelos Distrito de Saúde em Joinville, entre as `r ultimas_3_semanas` de `r ano_atual`. Para cada semana é apresentada a porcentagem de casos notificados que não puderam ser alocados em nenhum Distrito de Saúde devido a problemas no preenchimento ou ausência de informação sobre o local de ocorrência dos casos.

```{r echo=FALSE, fig.cap="Figura 12: Incidência de chikungunya (casos por 100.000 habitantes) nos distritos nas últimas 3 semanas epidemiológicas", fig.height=8}
fig12
```


## Perfil sazonal da transmissão das Arboviroses

O perfil sazonal das arboviroses está representado nos gráficos abaixo. O perfil sazonal da receptividade climática para os Distritos de Saúde (figura 13) apresenta uma escala que varia de 0 (período pouco receptivo) a 100 (período muito receptivo) sendo que, períodos muito receptivos, marcam a sazonalidade da doença.

```{r downscaling, echo=FALSE, fig.cap=paste0("Figura 13: Receptividade climática e temperatura mínima por distrito das últimas cinco SE. A linha amarela corresponde a temperatura mínima do município e as linhas verde, vermelha e azul para os distritos em específico. A área azul corresponde a período com receptividade climática favorável à transmissão de arboviroses, enquanto a área cinza a receptividade abaixo do limiar favorável.")}

fig13
```

O perfil sazonal das séries temporais de incidência de casos de dengue e chikungunya nos últimos 2 anos, respectivamente, para cada um dos Distritos, estão representadas na figura 14 e podem ser comparadas com a incidência desse ano (marcado em vermelho).


```{r fig14, echo=FALSE, fig.cap="Figura 14: Comparação da incidência de dengue dos Distritos do ano atual com do ano passado", fig.height=8}
fig14
```


O perfil de transmissibilidade para estas arboviroses (figura 15 e 16) é medido pelo número reprodutivo (Rt), calculado para cada distrito. Valores dessa métrica maiores que 1 ou mais de 3 semanas seguidas indicam transmissão sustentada de dengue ou chikungunya.


```{r fig15, echo=FALSE, fig.cap=paste0("Figura 16: Número reprodutivo de dengue por Distrito semanal estimado até a", week_atual), fig.height=8}
fig15

```

```{r fig16, echo=FALSE, fig.cap=paste0("Figura 16: Número reprodutivo de chikungunya por Distrito semanal estimado até a", week_atual), fig.height=8}
fig16

```

# Análise dos 10 Bairros com maior notificação

## Casos notificados, incidência e variação do risco

### dengue

A tabela 5 apresenta os 10 bairros com maior incidência de dengue e chikungunya atual, detalhando número de casos notificados, incidência, Rt, nível de alerta e número de semanas com nível de alerta de “Transmissão sustentada” e “Alta atividade”

```{r tab5, echo=FALSE}
tab5_ok

```

A figura 17 mostra o perfil de incidência de dengue nos três bairros que apresentaram a maior incidência na semana atual e as cores indicam o nível de atenção da semana epidemiológica. O código de cores indica o nível de alerta da semana epidemiológica. 


```{r fig17, echo=FALSE, fig.cap=paste0("Figura 17: Curva de incidência de dengue nos bairros de maior incidência na", week_atual,". A linha azul representa o número de casos notificados"), fig.height=11}
fig17

```


A figura 18 ilustra a incidência por 100 mil habitantes dos casos notificados de dengue agregados por bairros em Joinville, entre as `r ultimas_3_semanas` de `r ano_atual`. Para cada semana é apresentada a porcentagem de casos notificados que não puderam ser alocados em nenhum bairro devido a problemas no preenchimento ou ausência de informação sobre o local de ocorrência dos casos.

```{r fig18, echo=FALSE, fig.cap="Figura 19: Incidência de dengue nos bairros nas últimas 3 semanas epidemiológicas", fig.height=8}
fig18

```

### Chikungunya

A tabela 6 apresenta os 10 bairros com maior carga epidemiológica na semana atual, detalhando número de casos notificados, incidência, Rt, nível de alerta e frequência de permanência em baixo risco nas últimas 10 semanas.


```{r tab11, echo=FALSE}
tab6_ok

```

A figura 19 mostra o perfil de incidência de chikungunya nos três bairros que apresentaram a maior incidência na semana atual e as cores indicam o nível de atenção da semana epidemiológica. O código de cores indica o nível de alerta da semana epidemiológica. 

```{r fig19, echo=FALSE, fig.cap=paste0("Figura 19: Curva de incidência de chikungunya nos bairros de maior incidência na", week_atual,". A linha azul representa o número de casos notificados"), fig.height=11}
fig19

```


A figura 20 ilustra a incidência por 100 mil habitantes dos casos notificados de chikungunya agregados por bairros em Joinville, entre as `r ultimas_3_semanas` de `r ano_atual`. Para cada semana é apresentada a porcentagem de casos notificados que não puderam ser alocados em nenhum bairro devido a problemas no preenchimento ou ausência de informação sobre o local de ocorrência dos casos.


```{r fig20, echo=FALSE, fig.cap="Figura 20: Incidência nos bairros nas últimas 3 semanas epidemiológicas", fig.height=8}
fig20

```

