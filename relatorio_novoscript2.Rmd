---
title: "Boletim municipal - Joinville"
author: "ayrton"
date: "2025-07-16"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document:
    includes:
      in_header: header.tex
    extra_dependencies:
    - fancyhdr
    - graphicx
    - adjustbox
geometry: top=4cm, bottom=2.5cm, left=3cm, right=3cm, headheight=36pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# Verifica se os logos existem
if(!file.exists("./logo1.png")) stop("logo1.png não encontrado!")
if(!file.exists("./logo2.png")) stop("logo2.png não encontrado!")
```

\vspace\*{2cm}

<!-- Espaço para o cabeçalho -->

```{r pacotes, message=FALSE, warning=FALSE, include=FALSE}
# Configuração inicial
pacman::p_load(
  tidyverse,sf,magrittr,fuzzyjoin,
  lubridate,ggpubr,cowplot,gtable,
  nowcaster, AlertTools,epical,
  assertthat, patchwork, kableExtra,kable
)

source("./funcoes_submunicipal.R")

ano_atual <- year(Sys.Date())
```

considerando que o municipio possui tais caracteristicas urbanas, rurais e silvestres, considerando que existem pessoas morando nas areas rurais e silvestres (?), considerando o desenho de divisao de areas de saude, foi determinado que os casos das areas X, Y, Z que sao consideradas rurais/silvestres sào alocados/notificados como sendo parted dos tais e tais bairros, que esto nas seguintes divisoes. Desta forma, todos os casos notificados de pessoas que vevem em areas rurais/silvestrres estao contemplados nas analises.

```{r Carregando dados, message=FALSE, warning=FALSE, cache=T, include=FALSE}

# Carregar dados de referência
jv_pop <- read_csv2(
  file = "./dados_ref/joinville_pop.csv") %>% 
  mutate(nome_bairr = normalizar_bairro(nome_bairr)
)

jv_ref <- read_csv2(
  file = "./dados_ref/joinville_ref.csv",
  locale = locale(encoding = "Latin1")) %>% 
  mutate(nome_bairr = normalizar_bairro(nome_bairr)
)

jv_shp <- read_sf("./shapes/joinville_hotspots.shp")
distritos_shp <- read_sf("./shapes/UBSF-CENSO-2025-Infodengue.shp")

# Carregar dados de dengue
dg_arquivos <- c("./dados_casos/DENGON_SC_2024.dbf", "./dados_casos/DENGON_SC.dbf")
#ck_arquivos <- c("./dados_casos/CHIKON_SC.dbf")
dg2425 <- map_dfr(dg_arquivos, ler_dados_dengue)

# Dados para níveis de alerta
jvmun_shape <- geobr::read_municipality(code_muni = 4209102)
load("./Rt/clijv.RData") #substituir pelo downscale 
load("./Rt/paramsjv.RData")

# Dados API
dados_api <- read.csv('./dados_casos/dengue_1-29.csv') %>%
  select(SE, nivel, receptivo, Rt, casos, p_inc100k, tempmin) %>%
  mutate(ano = substr(SE, 1, 4)) %>%
  filter(ano %in% c(ano_atual-1, ano_atual)) |>
  mutate(geometry = jvmun_shape$geom)

# Semanas alvo
weeks_2_plot <- tail(
  unique(dg2425$SEM_NOT), 3
)
```

```{r processar_dados, include=FALSE}
# Processar dados principais
dg2 <- dg2425 %>%
  filter(NU_ANO %in% c(ano_atual-1, ano_atual)) %>%
  rename_with(tolower) %>%
  arrange(sem_not)

# Dados para nowcasting
nowcastdg <- dg2 %>% 
  select(nu_notific, nu_ano, sem_not, dt_sin_pri, dt_digita) %>%
  filter(year(dt_sin_pri) %in% c(ano_atual-2, ano_atual-1, ano_atual)) %>%
  drop_na(dt_sin_pri, dt_digita) %>%
  mutate(
    sem_not = substr(sem_not, 5, 6),
    se_sin_prin = epiweek(dt_sin_pri),
    ano_pri = year(dt_sin_pri)
  ) %>%
  rename(ano_notif = nu_ano, se_notif = sem_not) %>%
  select(dt_digita, dt_sin_pri)

# Normalizar nomes de bairros e fazer matching
dengJV2 <- dg2425 %>%
  mutate(NM_BAIRRO_NORM = normalizar_bairro(NM_BAIRRO)) %>%
  filter(!is.na(NM_BAIRRO_NORM))

# Matching fuzzy de bairros
bairros_parecidos <- stringdist_inner_join(
  dengJV2,
  tibble(NM_BAIRRO_REF = jv_ref$nome_bairr),
  by = c("NM_BAIRRO_NORM" = "NM_BAIRRO_REF"),
  method = "lv",
  max_dist = 2
)

# Preparar dados para nowcasting por distrito
distrito_nowcast <- bairros_parecidos %>% 
  select(NU_NOTIFIC, SEM_NOT, ID_BAIRRO, NM_BAIRRO_REF, DT_SIN_PRI, DT_DIGITA)

# Criar referência distrittos
res_distritos <- classificar_bairros_distrito(sp_distritos = distritos_shp,
                                              sp_bairros = jv_shp)
# Agrupar por bairro e semana
dg_bairros <- bairros_parecidos %>%
  count(NM_BAIRRO_REF, SEM_NOT, name = "notificações") %>%
  completar_dados_bairros(unique(bairros_parecidos$NM_BAIRRO_REF)) %>%
  left_join(jv_pop, by = c("NM_BAIRRO_REF" = "nome_bairr")) %>%
  left_join(jv_shp, by = "id_bairro") %>% 
  left_join(res_distritos) %>% 
  select(NM_BAIRRO_REF, SEM_NOT,Distrito, notificações,pop,geometry,geometry_distritos) %>% rename(SE = SEM_NOT)
  
# Adicionar informação de distritos
dados_api$geometry_mun <- sf::st_union(dg_bairros$geometry) 



```

```{r}
# missing 

dg2425 |> 
  group_by(SEM_NOT) %>% 
  summarise(
    total = n(),
    n_na = sum(is.na(ID_BAIRRO)),
    perc_na_id = 100*n_na/total
  ) -> dengJV_NA

dg2425 |> 
  group_by(SEM_NOT) %>% 
  summarise(
    total = n(),
    n_na = sum(is.na(NM_BAIRRO)),
    perc_na_nome = 100*n_na/total
  ) -> dengJV_NA2

cbind(dengJV_NA,dengJV_NA2) %>% as.data.frame() -> data_plot

data_plot[,c(1,4,8)] %>%
  mutate(ano = substr(SEM_NOT,1,4)) %>%
  pivot_longer(cols = 2:3, names_to = "var",
               values_to = "n") %>%
  mutate(var = case_when(
    var == "perc_na_id" ~ "ID_BAIRRO",
    var == "perc_na_nome" ~ "NM_BAIRRO"
  )) %>%
  ggplot()+
  geom_hline(yintercept = 70, linetype = "dashed", color = "black")+
  geom_line(aes(x = SEM_NOT, y = 100-n , col = var, group = var), size = 0.8,alpha = 0.8)+
  geom_text(aes(label="Quantidade mínima", x = 15, y = 73),) +
  theme_minimal(base_size = 11)+
  labs(y = "% de completude", x = "Semana Epidemiológicas", col = "",
       title = )+
  scale_color_manual(values=c("blue3","red3"))+
  scale_x_discrete(breaks = levels(data_plot$SEM_NOT)[seq(1, length(levels(data_plot$SEM_NOT)), by = 8)])+
  theme(axis.text.x = element_text(angle = 60,hjust = 1),
        axis.text  = element_text(colour = "black"),
        legend.position = "top")  -> missing_se; missing_se

# ggsave("./figuras boletim/missing_info.png",
#        missing_se,dpi = 600, width = 7, height = 5)


```


# Município

```{r municipio_nowscating, include=FALSE, cache=TRUE}

# Gerar nowcasting
jv_nowcast <- nowcasting_inla(
  dataset = nowcastdg,
  data.by.week = TRUE,
  date_onset = dt_sin_pri,
  date_report = dt_digita,
  K = 0, Dmax = 5
)

# Processar dados do nowcasting
jv_nowcast$total <- jv_nowcast$total %>%
  mutate(
    ano = year(dt_event),
    epiweek = epiweek(dt_event),
    ano_epi = case_when(
      epiweek == 1 & lag(epiweek, default = 52) == 52 ~ 
        paste0(year(dt_event) + 1, str_pad(epiweek, width = 2, pad = "0")),
      TRUE ~ paste0(year(dt_event), str_pad(epiweek, width = 2, pad = "0"))
    ),
    type = case_when(
      ano_epi > as.numeric(as.character(weeks_2_plot[3])) ~ 'Forecasting',
      TRUE ~ "Nowcasting"
    )
  )

# Preparar dados observados
dados_by_week <- nowcastdg %>%
  mutate(
    dt_event = dt_sin_pri,
    epiweek = epiweek(dt_event),
    ano = year(dt_event),
    ano_epi = paste0(ano, str_pad(epiweek, width = 2, pad = "0")) 
  ) %>% 
  count(ano_epi, dt_event, name = "total_Y") %>%
  filter(total_Y != 0 & ano_epi >= paste0(ano_atual - 1, "01")) %>%
  group_by(ano_epi) %>%
  summarise(total_Y = sum(total_Y)) %>%
  left_join(
    dados_api %>% mutate(SE = as.character(SE)) %>% select(SE, nivel),
    by = c("ano_epi" = "SE")
  )


```

```{r município_visualizacao, include=FALSE}

## Serie temporal (com nível e nowscater)

jv_inc <- create_incidence_plot( 
  nowcast_data = jv_nowcast$total, 
  observed_data = dados_by_week, 
  title_suffix = paste0("Curva de incidência - Joinville até SE", weeks_2_plot[3]),
  include_zoom = T, convert_to_incidence = T, pop = 616317
)

## Receptividade climática

jv_rec <- create_receptivity_plot(
  api_data = dados_api,
  weeks_limit = weeks_2_plot[3]
)

## Rt
jv_rt <- create_rt_plot(
  api_data = dados_api, 
  weeks_limit = weeks_2_plot[3], 
  title_suffix = paste0("Curva de Rt Joinville até ", weeks_2_plot[3]),
  lwr = 0, upr = 0
)


## Mapa com 3 últimos meses
jv_mun <- generate_maps(
  data = dados_api, geom_col = "geometry_mun",
  weeks_2_plot = as.numeric(as.character(weeks_2_plot))#,
  #shape = jvmun_shape
)

jv_3epiweeks <- create_map_panel(jv_mun)


## Tabela 
# falta construir. ver o site para exemplos

```

Até a semana epidemiológica (SE) 28, foram notificados **18.128** casos de dengue no município. Na última semana em questão, foram notificados **119** casos, resultando em uma incidência de **34.4** casos por 100.000 habitantes e com classificação de baixo risco. As figura 1 e 2 apresentam uma clara tendência de diminuição do número de casos, visto que as últimas três semanas apresentam redução do número de casos: SE 25 com **410** casos (risco alto), SE 26 com **303** (baixo risco) e SE 27 com **215** (baixo risco).

```{r municipio_plots, echo=FALSE, fig.cap= "Figura 1: Curva de incidência Joinville até SE 28/2025", message=FALSE, warning=FALSE}
# Município - Curva de incidência com nowcast
#ggsave("./figuras boletim/jv_inc.png",jv_inc,width = 7,height = 5, dpi =600)
print(jv_inc)

```

```{r municipio_maps, echo=FALSE, fig.height=7, fig.width=9, fig.cap= "Figura 2: Incidência (casos por 100.000 habitantes) no município nas últimas 3 semanas epidemiológicas"}
# Mapa de 3 últimas semanas
#ggsave("./figuras boletim/jv_3epiweeks.png",jv_3epiweeks,width = 8,height = 8, dpi = 600)
print(jv_3epiweeks)
```

A tendência de redução no número de notificações acompanha a queda na receptividade climática do município para a transmissão de arbovírus (Figura 3), com temperaturas mínimas abaixo do limiar favorável de 18°C registradas nas últimas 10 semanas epidemiológicas - diminuição já esperada devido às temperaturas mais baixas durante o inverno. Além disso, vemos que o número reprodutivo indica condições de transmissão não sustentada (Figura 4), corroborando com a redução do número de casos.

```{r municipio_receptivity, echo=FALSE, message=FALSE, warning=FALSE, fig.cap= "Figura 3: Receptividade climática e temperatura mínima até SE 28/2025"}
#ggsave("./figuras boletim/jv_rec.png",jv_rec + labs(title =""),width = 6,height = 4, dpi =600, bg = "white")
# Receptividade climática
print(jv_rec)
```

```{r municipio_rt, echo=FALSE, message=FALSE, warning=FALSE, fig.cap= "Figura 4: Número reprodutivo semanal estimado até SE 28/2025"}
#ggsave("./figuras boletim/jv_rt.png",jv_rt + labs(title =""),width = 6,height = 4, dpi =600, bg = "white")
# Rt
print(jv_rt)
```


# Distritos

```{r Mapa distritos, message=FALSE, warning=FALSE, include=FALSE, cache=TRUE}
# Preparação dos dados dos distritos (consolidado)
dg_distritos <- dg_bairros %>%
  group_by(SE, Distrito) %>%                
  summarise(
    pop_total = sum(pop, na.rm = TRUE), 
    not_total = sum(notificações, na.rm = TRUE), 
    geometry = st_union(geometry_distritos),
    .groups = "drop"
  ) %>% 
  mutate(
    inc = not_total/pop_total*1e5,
    ano = substr(SE, 1, 4)
  ) %>% 
  filter(ano %in% c(ano_atual-1, ano_atual))

# Mapa dos distritos
distritos_mapa <- ggplot() +
  geom_sf(data = jvmun_shape, 
          aes(geometry = geom, fill = "Região Rural"),
          color = "black"
) +
  geom_sf(
    data = dg_bairros %>% st_as_sf() %>%
       filter(SE == weeks_2_plot[1]),
    aes(geometry = geometry, fill = Distrito),
       color = "black", linewidth = 0.3
) + 
  ggpubr::theme_pubclean(
    base_size = 10
) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank()
) + 
  scale_fill_manual(
    name = "",
    values = c("Região Rural" = "white",
               "Distrito Centro" = "grey20",
               "Distrito Norte" = "grey50", 
               "Distrito Sul" = "grey70")
)


```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#ggsave("./figuras boletim/distritos.png",distritos_mapa,width = 7,height = 5,dpi = 600)
print(distritos_mapa)
```

```{r Preparacao dados alertas, message=FALSE, warning=FALSE, include=FALSE,cache=TRUE}
# Preparação dos dados para alertas (consolidado)
dg_distritos <- dg_distritos %>% 
  rename(casos = not_total) %>% 
  mutate(SE = as.numeric(SE)) %>% 
  left_join(dados_api %>% 
              ungroup() %>% 
              mutate(SE = as.numeric(as.character(SE))) %>% 
              select(SE, tempmin) %>% 
              rename(temp_min = tempmin),
            by = "SE"
) %>% 
  mutate(
    id_distrito = case_when(
      Distrito == "Distrito Norte" ~ 1,
      Distrito == "Distrito Sul" ~ 2,
      Distrito == "Distrito Centro" ~ 3
    ),
    ano = as.numeric(substr(SE, 1, 4)),
    inc = casos/pop_total*1e5
) %>% as.data.frame()

# Calcular alertas para todos os distritos
ids_distrito <- unique(dg_distritos$id_distrito)
nomes_distrito <- unique(dg_distritos$Distrito)

dg_distritos <- map2_dfr(ids_distrito, nomes_distrito, calcular_alerta,
data = dg_distritos, coluna_id = "id_distrito", gtdist = "normal",
meangt = 3, sdgt = 1)
```

```{r Nowcast distritos, message=FALSE, warning=FALSE, cache=TRUE, include=FALSE}
# Processar nowcast para todos os distritos
distritos <- unique(dg_distritos$Distrito)

# Processar dados de nowcast para todos os distritos
nowcast_resultados <- map(distritos, processar_nowcast_distrito, K = 1, Dmax = 5)
names(nowcast_resultados) <- distritos

populacoes_distritos <- c(
  "Distrito Centro" = 174752,
  "Distrito Norte" = 147823,
  "Distrito Sul" = 174616
)

# Criar gráficos
graficos_distritos <- map(names(nowcast_resultados), ~ {
  distrito_nome <- .x
  create_incidence_plot(
    nowcast_data = nowcast_resultados[[distrito_nome]]$nowcast$total,
    observed_data = nowcast_resultados[[distrito_nome]]$observado,
    distrito_nome = distrito_nome, 
    convert_to_incidence = T,
    pop = populacoes_distritos[distrito_nome],
    include_zoom = T, 
    title_suffix = distrito_nome
  )
})

names(graficos_distritos) <- distritos

## Rt
distrito_rt <- create_rt_plot(
  api_data = dg_distritos, 
  weeks_limit = weeks_2_plot[3], 
  title_suffix = paste0("Curva de Rt Joinville até ", weeks_2_plot[3]),
  facet_by = "Distrito", 
  lwr = lwr,
  upr = upr
)

## Mapa com 3 últimos meses
distrito_inc <- generate_maps(
  data = dg_distritos,value_col = "inc",
  weeks_2_plot = as.numeric(as.character(weeks_2_plot))#,
  #shape = jvmun_shape
)

distrito_3epiweeks <- create_map_panel(distrito_inc)


```


Dos casos passíveis de estratificação por distrito até a SE 28, observou-se a seguinte distribuição: 5.195 notificações no Distrito Centro, 4.669 no Distrito Norte e 4.192 no Distrito Sul (Figura 6). Na semana 28/2025, o número de casos foi maior no Distrito Centro, com **61** casos (incidência: **34,90)** reportados, seguido do Distrito Sul com **49** casos (incidência: **28.06**)reportados e Distrito Norte com **43** casos (incidência: **29,08**). Alinhando-se com a tendência municipal, todos os distritos apresentam redução progressiva nas notificações, evidenciada pelos menores números registrados nas últimas três semanas epidemiológicas (Figura 7). Atualmente, todas as regiões mantêm-se em baixo risco de transmissão, com os Distritos Centro e Norte nesta classificação desde a SE 26, enquanto o Sul permanece nesse patamar há quatro semanas consecutivas (SE 25 a 28). O número reprodutivo estimado para os distritos também indica transmissão insustentável em cada um deles (Figura 7).

```{r echo=FALSE, fig.cap="Figura 6: Curva de incidêncio para os Distritos Centro", fig.height=7, fig.width=9}
# Passo 1: Remover TODAS as legendas dos gráficos individuais
graficos_sem_legenda <- map(graficos_distritos, ~ {
  if (inherits(.x, "patchwork")) {
    # Se for um gráfico com zoom (patchwork), remove do gráfico principal
    .x[[1]] <- .x[[1]] + 
      theme(legend.position = "none") +
      guides(color = "none", fill = "none")
  } else {
    # Se for um gráfico simples (ggplot)
    .x <- .x + 
      theme(legend.position = "none") +
      guides(color = "none", fill = "none")
  }
  return(.x)
})

# Passo 2: Extrair APENAS UMA legenda (como você já fez)
legend_plot <- graficos_distritos[[length(graficos_distritos) - 2]] + 
  theme(legend.position = "top", 
        legend.box = "horizontal") +  # Garante legenda horizontal
  guides(color = guide_legend(title = "Nível de Risco"),
         fill = "none")  # Remove legenda de fill se existir

grob_legend <- ggplotGrob(legend_plot)
legend_grob <- gtable_filter(grob_legend, "guide-box")

# Passo 3: Montar o painel FINAL sem legendas nos subgráficos
final_plot <- ggdraw() +
  # Gráfico 1 (superior esquerdo)
  draw_plot(
    graficos_sem_legenda[[length(graficos_sem_legenda) - 2]],  # Remove patchwork se existir
    x = 0.06, y = 0.47, width = 0.4, height = 0.47
  ) +
  # Gráfico 2 (superior direito)
  draw_plot(
    graficos_sem_legenda[[length(graficos_sem_legenda) - 1]], 
    x = 0.55, y = 0.47, width = 0.4, height = 0.47
  ) +
  # Gráfico 3 (inferior central)
  draw_plot(
    graficos_sem_legenda[[length(graficos_sem_legenda)]], 
     x = 0.3, y = 0, width = 0.4, height = 0.47
  ) +
  # Legenda unificada
  draw_grob(
    legend_grob,
    x = 0.25,  # Ajuste horizontal
    y = -0.02,  # Ajuste vertical (pode precisar de valores negativos)
    width = 0.5
  )


```

```{r eval=FALSE, include=FALSE}
#ggsave("./figuras boletim/distritos_inc.png",final_plot,width = 8,height = 7,dpi = 600, bg = "white")

# plot
print(final_plot)
```

```{r}
centro <- graficos_distritos$`Distrito Centro`
norte <- graficos_distritos$`Distrito Norte`
sul <- graficos_distritos$`Distrito Sul`


distrito_inc_1col <- ggarrange(centro,
          norte,
          sul,
          ncol = 1
) 

# ggsave("./figuras boletim/distritos_inc_1col.png",distrito_inc_1col,width = 7,height = 10,dpi = 600, bg = "white")


```


```{r eval=FALSE, fig.cap=, message=FALSE, warning=FALSE, include=FALSE}
print(graficos_distritos$`Distrito Norte`)
```

```{r eval=FALSE, fig.cap=, message=FALSE, warning=FALSE, include=FALSE}
print(graficos_distritos$`Distrito Centro`)
```

```{r eval=FALSE, fig.cap=, message=FALSE, warning=FALSE, include=FALSE}
print(graficos_distritos$`Distrito Sul`)
```

```{r, fig.width=7, fig.height=10}
print(distrito_inc_1col)
```


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=7, fig.width=9, fig.cap= "Figura 7: Incidência (casos por 100.000 habitantes) nos distritos nas últimas 3 semanas epidemiológicas"}
ggsave("./figuras boletim/distrito_3epiweeks.png",distrito_3epiweeks,width = 9,height = 9, dpi = 600)
print(distrito_3epiweeks)
```

```{r echo=FALSE, fig.cap=" Figura 8: Número reprodutivo estimado para os Distritos Centro, Norte e Sul", message=FALSE, warning=FALSE}
ggsave("./figuras boletim/distrito_rt.png",distrito_rt + labs(title =""),width = 6,height = 6, dpi =600, bg = "white")


print(distrito_rt)

```

# Bairros

A Tabela 1 apresenta os 10 bairros com maior carga epidemiológica na semana atual, detalhando número de casos notificados, incidência, Rt, nível de alerta e frequência de permanência em baixo risco nas últimas 10 semanas.

```{r alerta bairros, message=FALSE, warning=FALSE, include=FALSE, cache=TRUE}

dg_bairros <- dg_bairros %>% 
  rename(casos = notificações) %>% 
  mutate(SE = as.numeric(SE)) %>% 
  left_join(dados_api %>% 
              ungroup() %>% 
              mutate(SE = as.numeric(as.character(SE))) %>% 
              select(SE, tempmin) %>% 
              rename(temp_min = tempmin),
            by = "SE"
) %>% 
  mutate(
  id_bairro = as.numeric(factor(NM_BAIRRO_REF)),
    ano = as.numeric(substr(SE, 1, 4)),
    inc = casos/pop*1e5
) %>% as.data.frame()

# Calcular alertas para todos os distritos
ids_bairro <- unique(dg_bairros$id_bairro)
nomes_bairro <- unique(dg_bairros$NM_BAIRRO_REF)

dg_bairros <- map2_dfr(ids_bairro, nomes_bairro, calcular_alerta, data = dg_bairros,    coluna_id = "id_bairro", gtdist = "normal", meangt = 3, sdgt = 1)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
bairros_inc_plot <- ggplot(data = dg_bairros %>% filter(id_bairro %in% 1:2) %>% 
                  filter(substr(SE,1,4) %in% c(ano_atual-1,ano_atual))) +
  # Segmentos (barras verticais)
  geom_segment(
    aes(x = factor(SE), xend = factor(SE), y = 0, yend = casos, color = factor(nivel)),
    linewidth = 0.7
  ) +
  # Linha observada
  geom_line(
    aes(x = factor(SE), y = casos, group = 1),
    color = "steelblue",
    linewidth = 1
  )  +
  # Escalas de cor
  scale_color_manual(
    name = NULL,
    values = c( "1" = "green", "2" = "yellow", "3" = "orange", "4" = "red"),
    labels = c("Nowcasting" = "Nowscating", "1" = "Baixo Risco", "2" = "Atenção", "3" = "Risco Moderado", "4" = "Risco alto"),
    breaks = c("Nowcasting", "1", "2", "3", "4")  # Itens da legenda na ordem desejada
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) + 
  scale_x_discrete(
    breaks = levels(factor(dg_bairros$SE))[seq(1, nlevels(factor(dg_bairros$SE)), by = 8)]
  )  + 
  labs( x = "Semanas Epidemiológicas", 
        y = "Casos notificados",
        title = paste0("Curva de incidência por bairro", " ", "até SE", weeks_2_plot[3])) +
 facet_wrap(~NM_BAIRRO_REF,  labeller = labeller(NM_BAIRRO_REF = function(x) paste("Bairro -", x)))

```

```{r include=FALSE}
bairros_inc_SE <- generate_maps(
  data = dg_bairros,value_col = "inc",
  weeks_2_plot = as.numeric(as.character(weeks_2_plot)),
  shape = dg_distritos, area = "Distrito"
)

bairros_3epiweeks <- create_map_panel(bairros_inc_SE)
```

```{r Tabela 10 bairros com maior número de casos, fig.cap="Tabela 1:"}

# Função para calcular semanas consecutivas com nível = 1 (versão mais robusta)
calcular_semanas_consecutivas <- function(data, semana_atual, bairro, janela = 10) {
  # Converter bairro para character e filtrar usando indexação base R
  bairro_char <- as.character(bairro)
  indices_bairro <- which(as.character(data$NM_BAIRRO_REF) == bairro_char)
  
  if (length(indices_bairro) == 0) return(0)
  
  # Extrair dados do bairro e ordenar por SE
  dados_bairro <- data[indices_bairro, ]
  dados_bairro <- dados_bairro[order(dados_bairro$SE), ]
  
  # Encontrar posição da semana atual
  pos_atual <- which(dados_bairro$SE == semana_atual)
  
  if (length(pos_atual) == 0) return(0)
  
  # Definir janela de análise (até 10 semanas anteriores)
  inicio_janela <- max(1, pos_atual - janela + 1)
  fim_janela <- pos_atual
  
  # Extrair níveis da janela
  niveis_janela <- dados_bairro$nivel[inicio_janela:fim_janela]
  
  # Contar semanas consecutivas com nível = 1 (da mais recente para trás)
  semanas_consecutivas <- 0
  for (i in length(niveis_janela):1) {
    if (!is.na(niveis_janela[i]) && niveis_janela[i] == 1) {
      semanas_consecutivas <- semanas_consecutivas + 1
    } else {
      break
    }
  }
  
  return(semanas_consecutivas)
}

# Aplicar função para cada bairro (versão mais eficiente)
dados_ultima_semana <- dg_bairros %>% 
  filter(SE == weeks_2_plot[3])

# Calcular semanas consecutivas para todos os bairros de uma vez
dados_ultima_semana$semanas_consecutivas_nivel1 <- sapply(
  dados_ultima_semana$NM_BAIRRO_REF, 
  function(bairro) calcular_semanas_consecutivas(dg_bairros, weeks_2_plot[3], bairro, janela = 10)
)

dados_ultima_semana %>% 
  arrange(desc(casos)) %>%
  slice_head(n = 10) %>%
  select(NM_BAIRRO_REF, Distrito, casos,  inc, Rt,
         nivel,semanas_consecutivas_nivel1) %>% 
  mutate(across(where(is.numeric), ~ format(.x, nsmall = 0, big.mark = ",",digits =2))) -> top_10_markdown
   # knitr::kable(format = "html", table.attr = "border='1' style='border-collapse: collapse;'",
   #             col.names = c("Bairro","Distrito",
   #                           "Casos","Incidência","Rt",
   #                           "Nível de Alerta",
   #                           "Semanas com nível baixo alerta"),
   #             align = "c") -> top_10_markdown

html_top10 <- kable(top_10_markdown, format = "html", table.attr = "border='1' style='border-collapse: collapse;'")
writeLines(html_top10, "top_10_bairros.html")
```

Nesta semana, o bairro Aventureiro registrou o maior número de casos notificados (18; incidência: 51,60), seguido por Boa Vista (9; 54,09) e América (8; 71,02). Os demais bairros do município apresentaram menos de 8 casos notificados e mantêm-se em baixo risco de transmissão. As curvas de incidência destes bairros estão ilutradas na figura 8.

```{r plotIncBairros, fig.height=7, fig.width=9, fig.cap="Figura 8: Curva de incidêncio nos bairros de maior incidência na semana 28/2025"}

top_3_bairros <- dg_bairros %>% 
  filter(SE == weeks_2_plot[3]) %>% 
  arrange(desc(casos)) %>%
  slice_head(n = 3) %>%
  select(NM_BAIRRO_REF) %>%
  pull()

  
lista_graficos <- dg_bairros %>% 
  filter(NM_BAIRRO_REF %in% top_3_bairros) %>%
  group_split(NM_BAIRRO_REF) %>%
  map(~{
    dados_bairro <- .x
    ultimas_semanas <- tail(sort(unique(dados_bairro$SE)), 5)
    
    # Gráfico principal
    p_main <- ggplot(dados_bairro) +
      geom_segment(
        aes(x = factor(SE), xend = factor(SE), 
        y = 0, yend = inc, color = factor(nivel)),
        linewidth = 0.7
      ) +
      geom_line(
        aes(x = factor(SE), y = inc, group = 1),
        color = "steelblue", linewidth = 1
      ) +
      scale_color_manual(
        name = NULL,
        values = c("1" = "green", "2" = "yellow", 
                   "3" = "orange", "4" = "red"),
        labels = c("1" = "Baixo Risco", 
                   "2" = "Atenção",
                   "3" = "Risco Moderado",
                   "4" = "Risco Alto"),
        breaks = c("1", "2", "3", "4")
      ) +
      theme_minimal() +
      theme(
        legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1)
      ) +
      scale_x_discrete(
        breaks = levels(factor(dados_bairro$SE))[
          seq(1, nlevels(factor(dados_bairro$SE)), by = 8)
        ]
      ) +
      labs(
        x = "Semanas Epidemiológicas",
        y = "Incidência (casos por 100.000 hab.)",
        title = unique(dados_bairro$NM_BAIRRO_REF)
      )
    
    # Gráfico de zoom (últimas 10 semanas)
    p_zoom <- dados_bairro %>% 
      filter(SE %in% ultimas_semanas) %>%
      ggplot() +
      geom_segment(
        aes(x = factor(SE), xend = factor(SE),
            y = 0, yend = inc, color = factor(nivel)),
        linewidth = 0.8
      ) +
      geom_line(
        aes(x = factor(SE), y = inc, group = 1),
        color = "steelblue", linewidth = 1.2
      ) +
      scale_color_manual(
        values = c("Nowcasting" = "blue", "1" = "green", "2" = "yellow",
                   "3" = "orange", "4" = "red")
      ) +
      scale_fill_manual(values = c("Nowcasting" = "blue"), guide = "none") +
      theme_minimal() +
      theme(
        legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1, size = 5),
        title = element_text(size = 6),
        plot.background = element_rect(fill = "white", color = "gray"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      ) +
      labs(x = NULL, y = NULL, title = "Últimas 5 semanas") +
      scale_x_discrete(
      breaks = levels(factor(dados_bairro$SE))[
        seq(1, nlevels(factor(dados_bairro$SE)), by = 3)
      ]
    ) 
    
    # Combinar os gráficos
    p_main + inset_element(p_zoom, left = 0.6, bottom = 0.3, right = 1, top = 1)
  })

# Nomear os elementos da lista com os nomes dos bairros
names(lista_graficos) <- dg_bairros %>% 
  filter(NM_BAIRRO_REF %in% top_3_bairros) %>% 
  pull(NM_BAIRRO_REF) %>% 
  unique()

  legend_plot <- lista_graficos[[length(lista_graficos) - 2]] + 
    theme(legend.position = "top") + 
    labs(fill = "legend_title")
  
  grob_legend <- ggplotGrob(legend_plot)
  legend_grob <- gtable_filter(grob_legend, "guide-box")

  # Criar painel
 bairros_inc_3 <-  ggdraw() +
    draw_plot(lista_graficos[[length(lista_graficos) - 2]] + theme(legend.position = "none"), 
              x = 0.06, y = 0.47, width = 0.4, height = 0.47) +
    draw_plot(lista_graficos[[length(lista_graficos) - 1]] + theme(legend.position = "none"), 
              x = 0.55, y = 0.47, width = 0.4, height = 0.47) +
    draw_plot(lista_graficos[[length(lista_graficos)]] + theme(legend.position = "none"), 
              x = 0.3, y = 0, width = 0.4, height = 0.47) +
    draw_grob(legend_grob, x = 0.23, y = 0,width = 0.5)

```

```{r eval=FALSE, include=FALSE}
ggsave("./figuras boletim/bairros_inc.png",bairros_inc_3,width = 7,height = 10,dpi = 600, bg = "white")
print(bairros_inc_3)
```

```{r}
bairro1 <- lista_graficos$AMERICA
bairro2 <- lista_graficos$AVENTUREIRO
bairro3 <- lista_graficos$`BOA VISTA`


bairro_inc_1col <- ggarrange(bairro1,
          bairro2,
          bairro3,
          ncol = 1
) 

ggsave("./figuras boletim/bairro_inc_1col.png",bairro_inc_1col,width = 7,height = 10,dpi = 600, bg = "white")
```



```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#print(bairros_inc_plot)
```

```{r, fig.width=7, fig.height=10}
print(bairro_inc_1col)
```


Assim como visto a nível de município e distritos, a incidência nas últimas 3 semanas em todos os bairros têm diminuído. No entanto, alguns bairros ainda se encontram com uma incidência considerável quando comparada aos demais, como os bairros Aventureiro, Jenivatuba, Boa Vista e América. Em geral, os bairros do Distrito Centro demonstraram uma incidência média de **346,36** casos por 100.00 habitantes, enquanto os do Distrito Norte apresentaram incidência média de **338,70** e **312,68** no tocante aos do Distrito Sul.

```{r mapa3bairros , echo=FALSE, fig.height=12, fig.width=10, message=FALSE, warning=FALSE, fig.cap= "Figura 9: Incidência (casos por 100.000 habitantes) nos bairros nas últimas 3 semanas epidemiológicas"}
ggsave("./figuras boletim/bairros_3epiweekss.png",bairros_3epiweeks,width = 9,height = 9,dpi = 600)
print(bairros_3epiweeks)
```
